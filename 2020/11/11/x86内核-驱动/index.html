<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>x86内核-驱动 | ZDDR's blog</title><meta name="keywords" content="C/C++,汇编"><meta name="author" content="ZDDR"><meta name="copyright" content="ZDDR"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="内核的一些概念Windows内核详细组成结构 函数从三环进入内核例程 HTL相关文件 各组件接口函数的前缀 创建第一个驱动创建WDM驱动模板 在VS中创建一个WDM驱动模板，名字随意    在低版本的vs中（2015以下），创建驱动模板时会出现两个工程，把第二个Packahe工程移除    在Source Files中创建一个.c文件名字随意    在这个.c文件中加入需要的驱动代码即可。  在这">
<meta property="og:type" content="article">
<meta property="og:title" content="x86内核-驱动">
<meta property="og:url" content="https://zddr.net/2020/11/11/x86%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/index.html">
<meta property="og:site_name" content="ZDDR&#39;s blog">
<meta property="og:description" content="内核的一些概念Windows内核详细组成结构 函数从三环进入内核例程 HTL相关文件 各组件接口函数的前缀 创建第一个驱动创建WDM驱动模板 在VS中创建一个WDM驱动模板，名字随意    在低版本的vs中（2015以下），创建驱动模板时会出现两个工程，把第二个Packahe工程移除    在Source Files中创建一个.c文件名字随意    在这个.c文件中加入需要的驱动代码即可。  在这">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.ax1x.com/2020/02/11/1oFBM8.png">
<meta property="article:published_time" content="2020-11-10T16:00:00.000Z">
<meta property="article:modified_time" content="2020-12-17T16:00:00.000Z">
<meta property="article:author" content="ZDDR">
<meta property="article:tag" content="C&#x2F;C++">
<meta property="article:tag" content="汇编">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.ax1x.com/2020/02/11/1oFBM8.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://zddr.net/2020/11/11/x86%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":1,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: ZDDR","link":"链接: ","source":"来源: ZDDR's blog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}

// https://stackoverflow.com/questions/16839698/jquery-getscript-alternative-in-native-javascript
const getScript = url => new Promise((resolve, reject) => {
  const script = document.createElement('script')
  script.src = url
  script.async = true
  script.onerror = reject
  script.onload = script.onreadystatechange = function() {
    const loadState = this.readyState
    if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
    script.onload = script.onreadystatechange = null
    resolve()
  }
  document.head.appendChild(script)
})</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2020-12-18 00:00:00'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><meta name="generator" content="Hexo 5.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="https://gitee.com/ZDDR/blog_img/raw/master/img/index_img/%E8%87%AA%E5%B7%B1%E7%9A%84%E5%A4%B4%E5%83%8F.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">18</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">7</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://s2.ax1x.com/2020/02/11/1oFBM8.png)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">ZDDR's blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">x86内核-驱动</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-11-10T16:00:00.000Z" title="发表于 2020-11-11 00:00:00">2020-11-11</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2020-12-17T16:00:00.000Z" title="更新于 2020-12-18 00:00:00">2020-12-18</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/windows%E5%86%85%E6%A0%B8/">windows内核</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="内核的一些概念"><a href="#内核的一些概念" class="headerlink" title="内核的一些概念"></a>内核的一些概念</h1><h2 id="Windows内核详细组成结构"><a href="#Windows内核详细组成结构" class="headerlink" title="Windows内核详细组成结构"></a>Windows内核详细组成结构</h2><p><img src="https://gitee.com/ZDDR/blog_img/raw/master/img/x86_kernel_drive/Windows%E5%86%85%E6%A0%B8%E8%AF%A6%E7%BB%86%E6%B3%A8%E5%86%8C%E7%BB%93%E6%9E%84.png" alt="image-20201113130409820"></p>
<h2 id="函数从三环进入内核例程"><a href="#函数从三环进入内核例程" class="headerlink" title="函数从三环进入内核例程"></a>函数从三环进入内核例程</h2><p><img src="https://gitee.com/ZDDR/blog_img/raw/master/img/x86_kernel_drive/%E5%87%BD%E6%95%B0%E4%BB%8E%E4%B8%89%E7%8E%AF%E8%BF%9B%E5%85%A5%E5%86%85%E6%A0%B8%E4%BE%8B%E7%A8%8B.png" alt="image-20201113131359876"></p>
<h2 id="HTL相关文件"><a href="#HTL相关文件" class="headerlink" title="HTL相关文件"></a>HTL相关文件</h2><p><img src="https://gitee.com/ZDDR/blog_img/raw/master/img/x86_kernel_drive/HTL%E7%9B%B8%E5%85%B3%E6%96%87%E4%BB%B6.png" alt="image-20201113130610406"></p>
<h2 id="各组件接口函数的前缀"><a href="#各组件接口函数的前缀" class="headerlink" title="各组件接口函数的前缀"></a>各组件接口函数的前缀</h2><p><img src="https://gitee.com/ZDDR/blog_img/raw/master/img/x86_kernel_drive/%E5%90%84%E7%BB%84%E4%BB%B6%E6%8E%A5%E5%8F%A3%E5%87%BD%E6%95%B0%E7%9A%84%E5%89%8D%E7%BC%80.png" alt="image-20201113131622264"></p>
<h1 id="创建第一个驱动"><a href="#创建第一个驱动" class="headerlink" title="创建第一个驱动"></a>创建第一个驱动</h1><h2 id="创建WDM驱动模板"><a href="#创建WDM驱动模板" class="headerlink" title="创建WDM驱动模板"></a>创建WDM驱动模板</h2><ol>
<li>在VS中创建一个WDM驱动模板，名字随意</li>
</ol>
<p><img src="https://gitee.com/ZDDR/blog_img/raw/master//img/x86_kernel_drive/WDM%E9%A9%B1%E5%8A%A8%E6%A8%A1%E6%9D%BF.png" alt="image-20201111152421403"></p>
<ol>
<li>在低版本的vs中（2015以下），创建驱动模板时会出现两个工程，把第二个Packahe工程移除</li>
</ol>
<p><img src="https://gitee.com/ZDDR/blog_img/raw/master/img/x86_kernel_drive/%E4%BD%8E%E7%89%88%E6%9C%ACVS%E4%B8%A4%E4%B8%AA%E5%B7%A5%E7%A8%8B.png" alt="image-20201111153016083"></p>
<ol>
<li>在<code>Source Files</code>中创建一个<code>.c</code>文件名字随意</li>
</ol>
<p><img src="https://gitee.com/ZDDR/blog_img/raw/master/img/x86_kernel_drive/Source%20Files%E4%B8%AD%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AAc%E6%96%87%E4%BB%B6.png" alt="image-20201111153126545"></p>
<ol>
<li>在这个<code>.c</code>文件中加入需要的驱动代码即可。</li>
</ol>
<h3 id="在这留一个DriverMain的标准模板"><a href="#在这留一个DriverMain的标准模板" class="headerlink" title="在这留一个DriverMain的标准模板"></a>在这留一个DriverMain的标准模板</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">DriverUnload</span><span class="params">(PDRIVER_OBJECT pDriver)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	KdPrint((<span class="string">&quot;DriverUnload\r\n&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT pDriver, PUNICODE_STRING pEeg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	pDriver-&gt;DriverUnload = DriverUnload;</span><br><span class="line">	KdPrint((<span class="string">&quot;DriverEntry\r\n&quot;</span>));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="驱动入口函数DriverEntry"><a href="#驱动入口函数DriverEntry" class="headerlink" title="驱动入口函数DriverEntry"></a>驱动入口函数DriverEntry</h2><p>在控制台的程序中，入口函数一般为<strong>Main</strong>，win32窗口程序为<strong>WinMain</strong>，DLL的入口函数为<strong>DllMain</strong>，而驱动的入口函数则是<code>DriverEntry</code>。</p>
<p>驱动入口的标准写法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT pDriver, PUNICODE_STRING pReg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//如果不改设置需要使用UNREFEREMCED_PARAMETRT(pDriver);</span></span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="返回值NTSTATUS"><a href="#返回值NTSTATUS" class="headerlink" title="返回值NTSTATUS"></a>返回值NTSTATUS</h3><p>当<a target="_blank" rel="noopener external nofollow noreferrer" href="https://docs.microsoft.com/zh-cn/windows-hardware/drivers/kernel/completing-irps">完成 irp</a>时，驱动程序在 Irp 的<a target="_blank" rel="noopener external nofollow noreferrer" href="https://docs.microsoft.com/zh-cn/windows-hardware/drivers/ddi/wdm/ns-wdm-_io_status_block"><strong>IO状态</strong></a>结构中提供一个 NTSTATUS 类型的值。 在 Ntdef 中定义了 NTSTATUS 类型，系统提供的状态代码是在 Ntstatus 中定义的。</p>
<p><strong>ntstatus</strong>值分为四种类型：成功值、信息值、警告和错误值.</p>
<p>简单来说，这个返回值保存着驱动的运行状态，类似于<code>GetlastError()</code>函数。</p>
<h3 id="参数1-PDRIVER-OBJECT-pDriver"><a href="#参数1-PDRIVER-OBJECT-pDriver" class="headerlink" title="参数1 PDRIVER_OBJECT pDriver"></a>参数1 PDRIVER_OBJECT pDriver</h3><p>这个参数保存这一个驱动对象，用来描述驱动的生命周期和详细信息，如名字、起始地址、大小，回调等等。</p>
<h3 id="参数2-PUNICODE-STRING-pReg"><a href="#参数2-PUNICODE-STRING-pReg" class="headerlink" title="参数2 PUNICODE_STRING pReg"></a>参数2 PUNICODE_STRING pReg</h3><p>PUNICODE_STRING指向了包含unicode字符串的缓冲区。这个参数保存着驱动的注册路径。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">UNICODE_STRING</span> &#123;</span></span><br><span class="line">    USHORT Length;</span><br><span class="line">    USHORT MaximumLength;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> MIDL_PASS</span></span><br><span class="line">    [size_is(MaximumLength / <span class="number">2</span>), length_is((Length) / <span class="number">2</span>) ] USHORT * Buffer;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span> <span class="comment">// MIDL_PASS</span></span></span><br><span class="line">    _Field_size_bytes_part_opt_(MaximumLength, Length) PWCH   Buffer;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// MIDL_PASS</span></span></span><br><span class="line">&#125; UNICODE_STRING;</span><br><span class="line"><span class="keyword">typedef</span> UNICODE_STRING *PUNICODE_STRING;</span><br></pre></td></tr></table></figure>
<h2 id="驱动卸载"><a href="#驱动卸载" class="headerlink" title="驱动卸载"></a>驱动卸载</h2><p>在<strong>DriverEntry</strong>中有一个描述驱动生命周期的参数<code>pDriver</code>,所以卸载应该也是他来描述。</p>
<p>pDriver有一个成员DriverUnload，需要给他一个我们自己定义的卸载函数指针。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pDriver-&gt;DriverUnload</span><br></pre></td></tr></table></figure>
<p>这个函数的定义：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID <span class="title">DRIVER_UNLOAD</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    _In_ struct _DRIVER_OBJECT *DriverObject</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span>;</span><br></pre></td></tr></table></figure>
<p>完整代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DriverUnload</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">	_In_ struct _DRIVER_OBJECT* DriverObject</span></span></span><br><span class="line"><span class="function"><span class="params">	)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	DbgPrint(<span class="string">&quot;%s,%d,%s\r\n&quot;</span>, __FUNCTION__, __LINE__, __TIME__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT pDriver, PUNICODE_STRING pReg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	pDriver-&gt;DriverUnload = DriverUnload;</span><br><span class="line"></span><br><span class="line">	DbgPrint(<span class="string">&quot;%wZ&quot;</span>, pReg);</span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="驱动注册了什么？"><a href="#驱动注册了什么？" class="headerlink" title="驱动注册了什么？"></a>驱动注册了什么？</h2><p>在<strong>DriverEntry</strong>函数中的第二个参数的参数<code>pReg</code>保存了驱动的注册路径，可以使用DbgPrint输出在WinDbg或DebugView中查看</p>
<p><img src="https://gitee.com/ZDDR/blog_img/raw/master/img/x86_kernel_drive/preg%E6%B3%A8%E5%86%8C%E8%A1%A8%E8%B7%AF%E5%BE%84.png" alt="image-20201111163353694"></p>
<p>根据路径可以在注册表中找到对应存储的值</p>
<p><img src="https://gitee.com/ZDDR/blog_img/raw/master/img/x86_kernel_drive/%E6%A0%B9%E6%8D%AE%E8%B7%AF%E5%BE%84%E5%8F%AF%E4%BB%A5%E5%9C%A8%E6%B3%A8%E5%86%8C%E8%A1%A8%E4%B8%AD%E6%89%BE%E5%88%B0%E5%AF%B9%E5%BA%94%E5%AD%98%E5%82%A8%E7%9A%84%E5%80%BC.png" alt="image-20201111164438790"></p>
<ul>
<li>DisplayName（服务名）</li>
<li>ErrorControl（错误控制码）</li>
<li>ImagePath（驱动所在路径）</li>
<li>Start（0~2自启驱动，3手动启动）</li>
<li>Type (区分服务或者驱动)</li>
</ul>
<h2 id="驱动与WinDbg联动调试"><a href="#驱动与WinDbg联动调试" class="headerlink" title="驱动与WinDbg联动调试"></a>驱动与WinDbg联动调试</h2><p>使用DbgBreakPoint让驱动与WinDbg联动调试</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DriverUnload</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">	_In_ struct _DRIVER_OBJECT* DriverObject</span></span></span><br><span class="line"><span class="function"><span class="params">	)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	DbgPrint(<span class="string">&quot;%s,%d,%s\r\n&quot;</span>, __FUNCTION__, __LINE__, __TIME__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT pDriver, PUNICODE_STRING pReg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	DbgBreakPoint();</span><br><span class="line">	pDriver-&gt;DriverUnload = DriverUnload;</span><br><span class="line"></span><br><span class="line">	DbgPrint(<span class="string">&quot;%wZ&quot;</span>, pReg);</span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>效果</p>
<p><img src="https://gitee.com/ZDDR/blog_img/raw/master/img/x86_kernel_drive/%E9%A9%B1%E5%8A%A8%E4%B8%8EWinDbg%E8%81%94%E5%8A%A8%E8%B0%83%E8%AF%95.png" alt="image-20201111202102285"></p>
<p>注意！WinDbg要开启源码模式（红色箭头），而且WinDbg要能找到符号文件。</p>
<h1 id="蓝屏调试"><a href="#蓝屏调试" class="headerlink" title="蓝屏调试"></a>蓝屏调试</h1><p>蓝屏日志目录：<code>C:\Windows\Minidump</code></p>
<h2 id="错误1：线程未结束"><a href="#错误1：线程未结束" class="headerlink" title="错误1：线程未结束"></a>错误1：线程未结束</h2><h3 id="基本信息"><a href="#基本信息" class="headerlink" title="基本信息"></a>基本信息</h3><p>在这段代码里，我使用<code>PsCreateSystemThread</code>函数创建了一个系统线程，让他调用test函数每秒输出一行字符，在卸载驱动的时候我没有把线程结束，但是代码模块的内存已经被回收，导致蓝屏。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">test</span><span class="params">(_In_ PVOID StartContext)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	LARGE_INTEGER time = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	time.QuadPart = <span class="number">-10000</span> * <span class="number">1000</span>;</span><br><span class="line">	<span class="keyword">while</span> (TRUE)</span><br><span class="line">	&#123;</span><br><span class="line">		KdPrint((<span class="string">&quot;-------------&quot;</span>));</span><br><span class="line">		KeDelayExecutionThread(KernelMode, FALSE, &amp;time);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">DriverUnload</span><span class="params">(PDRIVER_OBJECT pDriver)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	KdPrint((<span class="string">&quot;DriverUnload\r\n&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT pDriver, PUNICODE_STRING pEeg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HANDLE ThreadHandle = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	PsCreateSystemThread(&amp;ThreadHandle, THREAD_ALL_ACCESS, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, test, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	pDriver-&gt;DriverUnload = DriverUnload;</span><br><span class="line">	KdPrint((<span class="string">&quot;DriverEntry\r\n&quot;</span>));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>点击卸载驱动，Windbg捕获到蓝屏</p>
<p><img src="https://gitee.com/ZDDR/blog_img/raw/master/img/x86_kernel_drive/Windbg%E6%8D%95%E8%8E%B7%E5%88%B0%E7%BA%BF%E7%A8%8B%E6%9C%AA%E7%BB%93%E6%9D%9F%E8%93%9D%E5%B1%8F.png" alt="image-20201112153813325"></p>
<p>使用<code>!analyze -v</code>命令让Windbg自动分析蓝屏原因</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line">1: kd&gt; !analyze -v</span><br><span class="line">*******************************************************************************</span><br><span class="line">*                                                                             *</span><br><span class="line">*                        Bugcheck Analysis                                    *</span><br><span class="line">*                                                                             *</span><br><span class="line">*******************************************************************************</span><br><span class="line"></span><br><span class="line">DRIVER_UNLOADED_WITHOUT_CANCELLING_PENDING_OPERATIONS (ce)</span><br><span class="line">A driver unloaded without cancelling timers, DPCs, worker threads, etc.</span><br><span class="line">The broken driver<span class="string">&#x27;s name is displayed on the screen and saved in</span></span><br><span class="line"><span class="string">KiBugCheckDriver.</span></span><br><span class="line"><span class="string">Arguments:</span></span><br><span class="line"><span class="string">Arg1: 980350b0, memory referenced</span></span><br><span class="line"><span class="string">Arg2: 00000008, value 0 = read operation, 1 = write operation</span></span><br><span class="line"><span class="string">Arg3: 980350b0, If non-zero, the instruction address which referenced the bad memory</span></span><br><span class="line"><span class="string">	address.</span></span><br><span class="line"><span class="string">Arg4: 00000000, Mm internal code.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Debugging Details:</span></span><br><span class="line"><span class="string">------------------</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">KEY_VALUES_STRING: 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">PROCESSES_ANALYSIS: 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">SERVICE_ANALYSIS: 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">STACKHASH_ANALYSIS: 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">TIMELINE_ANALYSIS: 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">DUMP_CLASS: 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">DUMP_QUALIFIER: 0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">BUILD_VERSION_STRING:  7601.17514.x86fre.win7sp1_rtm.101119-1850</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">DUMP_TYPE:  0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">BUGCHECK_P1: ffffffff980350b0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">BUGCHECK_P2: 8</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">BUGCHECK_P3: ffffffff980350b0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">BUGCHECK_P4: 0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">WRITE_ADDRESS:  980350b0 </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">FAULTING_IP: </span></span><br><span class="line"><span class="string">Test_Dbg.sys+10b0</span></span><br><span class="line"><span class="string">980350b0 ??              ???</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">IMAGE_NAME:  Test_Dbg.sys</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">DEBUG_FLR_IMAGE_TIMESTAMP:  0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">MODULE_NAME: Test_Dbg</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">FAULTING_MODULE: 00000000 </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">CPU_COUNT: 2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">CPU_MHZ: af8</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">CPU_VENDOR:  GenuineIntel</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">CPU_FAMILY: 6</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">CPU_MODEL: 9e</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">CPU_STEPPING: 9</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">CPU_MICROCODE: 6,9e,9,0 (F,M,S,R)  SIG: 8E&#x27;</span>00000000 (cache) 8E<span class="string">&#x27;00000000 (init)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">DEFAULT_BUCKET_ID:  WIN7_DRIVER_FAULT</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">BUGCHECK_STR:  0xCE</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">PROCESS_NAME:  System</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">CURRENT_IRQL:  2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ANALYSIS_SESSION_HOST:  DESKTOP-8N9A3Q3</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ANALYSIS_SESSION_TIME:  11-12-2020 15:41:02.0659</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ANALYSIS_VERSION: 10.0.18362.1 x86fre</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">TRAP_FRAME:  a3d77bd4 -- (.trap 0xffffffffa3d77bd4)</span></span><br><span class="line"><span class="string">ErrCode = 00000010</span></span><br><span class="line"><span class="string">eax=00000000 ebx=00000000 ecx=00000000 edx=00000000 esi=863ed3f0 edi=00000000</span></span><br><span class="line"><span class="string">eip=980350b0 esp=a3d77c48 ebp=a3d77c50 iopl=0         nv up ei pl zr na pe nc</span></span><br><span class="line"><span class="string">cs=0008  ss=0010  ds=0023  es=0023  fs=0030  gs=0000             efl=00010246</span></span><br><span class="line"><span class="string">&lt;Unloaded_Test_Dbg.sys&gt;+0x10b0:</span></span><br><span class="line"><span class="string">980350b0 ??              ???</span></span><br><span class="line"><span class="string">Resetting default scope</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">IP_MODULE_UNLOADED: </span></span><br><span class="line"><span class="string">Test_Dbg.sys+10b0</span></span><br><span class="line"><span class="string">980350b0 ??              ???</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">LAST_CONTROL_TRANSFER:  from 83ee5083 to 83e81110</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">STACK_TEXT:  </span></span><br><span class="line"><span class="string">a3d7771c 83ee5083 00000003 93ecd669 00000065 nt!RtlpBreakWithStatusInstruction</span></span><br><span class="line"><span class="string">a3d7776c 83ee5b81 00000003 863ed3f0 00000000 nt!KiBugCheckDebugBreak+0x1c</span></span><br><span class="line"><span class="string">a3d77b30 83e9441b 00000050 980350b0 00000008 nt!KeBugCheck2+0x68b</span></span><br><span class="line"><span class="string">a3d77bbc 83e473d8 00000008 980350b0 00000000 nt!MmAccessFault+0x106</span></span><br><span class="line"><span class="string">a3d77bbc 980350b0 00000008 980350b0 00000000 nt!KiTrap0E+0xdc</span></span><br><span class="line"><span class="string">WARNING: Frame IP not in any known module. Following frames may be wrong.</span></span><br><span class="line"><span class="string">a3d77c44 fa0a1f00 ffffffff a3d77c90 8400ff5e &lt;Unloaded_Test_Dbg.sys&gt;+0x10b0</span></span><br><span class="line"><span class="string">a3d77c50 8400ff5e 00000000 93ecdd95 00000000 0xfa0a1f00</span></span><br><span class="line"><span class="string">a3d77c90 83eb7219 98035070 00000000 00000000 nt!PspSystemThreadStartup+0x9e</span></span><br><span class="line"><span class="string">00000000 00000000 00000000 00000000 00000000 nt!KiThreadStartup+0x19</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">THREAD_SHA1_HASH_MOD_FUNC:  88ce40b87ec9c565c6934cabebc1d82b3f5eb564</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">THREAD_SHA1_HASH_MOD_FUNC_OFFSET:  a587c8c4dce77b1177b2eef9c95ef006a88470bf</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">THREAD_SHA1_HASH_MOD:  fd0532b46e9c45be4bce198c2a52d7b7cadcb567</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">FOLLOWUP_NAME:  MachineOwner</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">STACK_COMMAND:  .thread ; .cxr ; kb</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">FAILURE_BUCKET_ID:  0xCE_IMAGE_Test_Dbg.sys</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">BUCKET_ID:  0xCE_IMAGE_Test_Dbg.sys</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">PRIMARY_PROBLEM_CLASS:  0xCE_IMAGE_Test_Dbg.sys</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">TARGET_TIME:  2020-11-12T07:27:51.000Z</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">OSBUILD:  7601</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">OSSERVICEPACK:  1000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">SERVICEPACK_NUMBER: 0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">OS_REVISION: 0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">SUITE_MASK:  272</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">PRODUCT_TYPE:  1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">OSPLATFORM_TYPE:  x86</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">OSNAME:  Windows 7</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">OSEDITION:  Windows 7 WinNt (Service Pack 1) TerminalServer SingleUserTS</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">OS_LOCALE:  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">USER_LCID:  0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">OSBUILD_TIMESTAMP:  2010-11-20 16:42:49</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">BUILDDATESTAMP_STR:  101119-1850</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">BUILDLAB_STR:  win7sp1_rtm</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">BUILDOSVER_STR:  6.1.7601.17514.x86fre.win7sp1_rtm.101119-1850</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ANALYSIS_SESSION_ELAPSED_TIME:  9b9</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ANALYSIS_SOURCE:  KM</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">FAILURE_ID_HASH_STRING:  km:0xce_image_test_dbg.sys</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">FAILURE_ID_HASH:  &#123;4ad09124-26b0-e75e-3af2-80aa825b797f&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Followup:     MachineOwner</span></span><br><span class="line"><span class="string">---------</span></span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/ZDDR/blog_img/raw/master/img/x86_kernel_drive/windbg%E7%BA%BF%E7%A8%8B%E6%9C%AA%E5%81%9C%E6%AD%A2%E8%93%9D%E5%B1%8F%E5%88%86%E6%9E%90%E7%BB%93%E6%9E%9C.png" alt="image-20201112154251518"></p>
<p>首先来看第一行</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DRIVER_UNLOADED_WITHOUT_CANCELLING_PENDING_OPERATIONS (ce)</span><br></pre></td></tr></table></figure>
<p>蓝屏错误码为0xce，前面是给这个编号ce的错误起了一个名字。在官方文档中可以查找到对应错误码的详细信息。</p>
<p>官方文档对这个错误的解释为：</p>
<blockquote>
<p>This indicates that a driver failed to cancel pending operations before unloading.(驱动程序无法在卸载前取消挂起的操作)</p>
</blockquote>
<p>解释的下面还带有4个参数（红框位置）</p>
<p><img src="https://gitee.com/ZDDR/blog_img/raw/master/img/x86_kernel_drive/0xce%E9%94%99%E8%AF%AF%E6%96%87%E6%A1%A3.png" alt="image-20201112155043940"></p>
<p>这四个参数对应WinDbg中的</p>
<p><img src="https://gitee.com/ZDDR/blog_img/raw/master/img/x86_kernel_drive/%E7%BA%BF%E7%A8%8B%E8%93%9D%E5%B1%8F%E5%9B%9B%E4%B8%AA%E5%8F%82%E6%95%B0.png" alt="image-20201112155412063"></p>
<p>参数Arg1 <strong>Memory address referenced</strong>(引用的内存地址)</p>
<p>参数Arg2 值为8 意思是执行</p>
<p>参数Arg3 如果非零，则引用坏内存的指令地址（EIP）</p>
<p>参数Arg4 保留</p>
<p>更多错误类型可以查看官方文档☛[<a target="_blank" rel="noopener external nofollow noreferrer" href="https://docs.microsoft.com/zh-cn/windows-hardware/drivers/debugger/bug-check-code-reference2">Bug Check Code Reference]</a></p>
<p>再往下看，可以看到一个<code>WRITE_ADDRESS</code>和 <code>FAULTING_IP</code>，这个地址就是触发蓝屏EIP</p>
<p><img src="https://gitee.com/ZDDR/blog_img/raw/master/img/x86_kernel_drive/WRITE_ADDRESS.png" alt="image-20201112160314824"></p>
<p>继续往下</p>
<p><code>DEFAULT_BUCKET_ID: WIN7_DRIVER_FAULT</code> WIN7驱动程序故障</p>
<p><code>BUGCHECK_STR: 0xCE</code> 错误编号0xce</p>
<p><code>PROCESS_NAME: System</code> 什么进程引用的错误地址</p>
<p><code>CURRENT_IRQL: 2</code> 当前RIQL等级</p>
<p>发生错误时的寄存器信息</p>
<p><img src="https://gitee.com/ZDDR/blog_img/raw/master/img/x86_kernel_drive/%E5%8F%91%E7%94%9F%E9%94%99%E8%AF%AF%E6%97%B6%E5%AF%84%E5%AD%98%E5%99%A8%E4%BF%A1%E6%81%AF.png" alt="image-20201112161145276"></p>
<p>调用堆栈中可以看到是卸载的时候触发的0E号异常</p>
<p><img src="https://gitee.com/ZDDR/blog_img/raw/master/img/x86_kernel_drive/%E5%8F%91%E7%94%9F%E9%94%99%E8%AF%AF%E6%97%B6%E7%9A%84%E8%B0%83%E7%94%A8%E5%A0%86%E6%A0%88.png" alt="image-20201112161224390"></p>
<p>还有触发异常的驱动名字</p>
<p><img src="https://gitee.com/ZDDR/blog_img/raw/master/img/x86_kernel_drive/%E8%A7%A6%E5%8F%91%E5%BC%82%E5%B8%B8%E7%9A%84%E9%A9%B1%E5%8A%A8%E5%90%8D%E5%AD%97.png" alt="image-20201112161615567"></p>
<h3 id="堆栈信息"><a href="#堆栈信息" class="headerlink" title="堆栈信息"></a>堆栈信息</h3><p>在Windbg中使用<code>k</code>查看堆栈信息</p>
<p><img src="https://gitee.com/ZDDR/blog_img/raw/master/img/x86_kernel_drive/k%E6%9F%A5%E7%9C%8B%E5%A0%86%E6%A0%88%E4%BF%A1%E6%81%AF.png" alt="image-20201112161927358"></p>
<p>使用<code>kv</code>查看详细堆栈信息,可以看到<strong>Trap Frame</strong>陷阱帧</p>
<p><img src="https://gitee.com/ZDDR/blog_img/raw/master/img/x86_kernel_drive/KV.png" alt="image-20201112162145084"></p>
<p>使用<code>.trap 帧地址</code>打印出现异常时的寄存器现场和报错的地址</p>
<p><img src="https://gitee.com/ZDDR/blog_img/raw/master/img/x86_kernel_drive/%E4%BD%BF%E7%94%A8trap%E5%B8%A7%E5%9C%B0%E5%9D%80%E6%89%93%E5%8D%B0%E5%87%BA%E7%8E%B0%E5%BC%82%E5%B8%B8%E6%97%B6%E7%9A%84%E5%AF%84%E5%AD%98%E5%99%A8%E7%8E%B0%E5%9C%BA.png" alt="image-20201112162525039"></p>
<p>以及<strong>KP、KN</strong>等等信息。</p>
<h3 id="通过IDA定位错误函数"><a href="#通过IDA定位错误函数" class="headerlink" title="通过IDA定位错误函数"></a>通过IDA定位错误函数</h3><p>在使用<code>kv</code>查看堆栈详细信息的时候，还能看到一个关键信息——触发异常的代码位置</p>
<p><img src="https://gitee.com/ZDDR/blog_img/raw/master/img/x86_kernel_drive/%E8%A7%A6%E5%8F%91%E5%BC%82%E5%B8%B8%E7%9A%84%E4%BB%A3%E7%A0%81%E4%BD%8D%E7%BD%AE.png" alt="image-20201112201143630"></p>
<p>很明显这行的意思的是<strong>基址+偏移</strong>，那么基址是多少呢？怎么找到这个位置呢？</p>
<p>首先把驱动拖入IDA，直接在反汇编窗口拉到最上方可以看到<code>.text:00401000</code></p>
<p><img src="https://gitee.com/ZDDR/blog_img/raw/master/img/x86_kernel_drive/%E7%BA%BF%E7%A8%8B%E5%9F%BA%E5%9D%80.png" alt="image-20201112201918448"></p>
<p>这个地址为<strong>基址+虚拟地址</strong>的地址，现在我们要知道虚拟地址是多少，把驱动文件拖入PE文件查看器就能看到，虚拟地址的值为0x1000</p>
<p><img src="https://gitee.com/ZDDR/blog_img/raw/master/img/x86_kernel_drive/%E5%B0%8F%E8%BE%A3%E6%A4%92%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80.png" alt="image-20201112202223461"></p>
<p>接下来用0x00401000减去0x1000得到的0x00400000就是基址</p>
<p>把基址加上0x10b0得到0x004010b0，这个就是出现异常的函数地址</p>
<p>在IDA中按<code>g</code>输入这个地址跳就可以来到函数位置</p>
<p><img src="https://gitee.com/ZDDR/blog_img/raw/master/img/x86_kernel_drive/g%E8%B7%B3%E8%BD%AC.png" alt="image-20201112202458734"></p>
<p>现在就可以使用F5或者其他方式对问题函数进行分析</p>
<p><img src="https://gitee.com/ZDDR/blog_img/raw/master/img/x86_kernel_drive/F5%E9%97%AE%E9%A2%98%E5%87%BD%E6%95%B0.png" alt="image-20201112202642577"></p>
<h3 id="ln指令"><a href="#ln指令" class="headerlink" title="ln指令"></a>ln指令</h3><p>在没有符号时可以使用<code>ln</code>命令尝试推测出函数对应符号（不一定准确）</p>
<p><img src="https://gitee.com/ZDDR/blog_img/raw/master/img/x86_kernel_drive/%E4%BD%BF%E7%94%A8ln%E5%91%BD%E4%BB%A4%E5%B0%9D%E8%AF%95%E6%8E%A8%E6%B5%8B%E5%87%BA%E5%87%BD%E6%95%B0%E5%AF%B9%E5%BA%94%E7%AC%A6%E5%8F%B7.png" alt="image-20201112204557995"></p>
<h2 id="错误2：堆栈溢出"><a href="#错误2：堆栈溢出" class="headerlink" title="错误2：堆栈溢出"></a>错误2：堆栈溢出</h2><p>在内核中，堆栈空间是比较小的，所以我在代码中使用<code>char buf[1024 * 1024] = &#123; 0 &#125;;</code>把堆栈空间全部吃满，再调用一个<code>Test</code>函数，触发蓝屏。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">test</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	KdPrint((<span class="string">&quot;-----------------\r\n&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">DriverUnload</span><span class="params">(PDRIVER_OBJECT pDriver)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	KdPrint((<span class="string">&quot;DriverUnload\r\n&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT pDriver, PUNICODE_STRING pEeg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">1024</span> * <span class="number">1024</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">	test();</span><br><span class="line"></span><br><span class="line">	pDriver-&gt;DriverUnload = DriverUnload;</span><br><span class="line">	KdPrint((<span class="string">&quot;DriverEntry\r\n&quot;</span>));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行驱动直接蓝屏</p>
<p><img src="https://gitee.com/ZDDR/blog_img/raw/master/img/x86_kernel_drive/%E5%A0%86%E6%A0%88%E6%BA%A2%E5%87%BA%E8%93%9D%E5%B1%8F.png" alt="image-20201112221020399"></p>
<h2 id="错误3：0地址错误"><a href="#错误3：0地址错误" class="headerlink" title="错误3：0地址错误"></a>错误3：0地址错误</h2><p>在这段代码中，我直接对0地址执行了写操作，导致蓝屏</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">DriverUnload</span><span class="params">(PDRIVER_OBJECT pDriver)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	KdPrint((<span class="string">&quot;DriverUnload\r\n&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT pDriver, PUNICODE_STRING pEeg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span>* x = <span class="number">0</span>;</span><br><span class="line">	*x = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">	pDriver-&gt;DriverUnload = DriverUnload;</span><br><span class="line">	KdPrint((<span class="string">&quot;DriverEntry\r\n&quot;</span>));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">!thread</span><br><span class="line">!process</span><br><span class="line">!devobj</span><br></pre></td></tr></table></figure>
<p>使用<code>.thread</code>或<code>.process</code>错误语法，报出错误地址，然后查看</p>
<p><img src="https://gitee.com/ZDDR/blog_img/raw/master/img/x86_kernel_drive/%E6%8A%A5%E5%87%BA%E9%94%99%E8%AF%AF%E5%9C%B0%E5%9D%80%EF%BC%8C%E7%84%B6%E5%90%8E%E6%9F%A5%E7%9C%8B.png" alt="image-20201113005616367"></p>
<h1 id="驱动断链"><a href="#驱动断链" class="headerlink" title="驱动断链"></a>驱动断链</h1><h2 id="PDRIVER-OBJECT结构"><a href="#PDRIVER-OBJECT结构" class="headerlink" title="PDRIVER_OBJECT结构"></a>PDRIVER_OBJECT结构</h2><p>运行此代码，使用WinDbg进行调试，分析PDRIVER_OBJECT结构</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">DriverUnload</span><span class="params">(PDRIVER_OBJECT pDriver)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	KdPrint((<span class="string">&quot;DriverUnload\r\n&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT pDriver, PUNICODE_STRING pEeg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	DbgBreakPoint();</span><br><span class="line">	pDriver-&gt;DriverUnload = DriverUnload;</span><br><span class="line">	KdPrint((<span class="string">&quot;DriverEntry\r\n&quot;</span>));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>WinDbg断下，使用<code>dt pDriver</code>查看PDRIVER_OBJECT结构</p>
<p><img src="https://gitee.com/ZDDR/blog_img/raw/master/img/x86_kernel_drive/%E6%9F%A5%E7%9C%8BPDRIVER_OBJECT%E7%BB%93%E6%9E%84.png" alt="image-20201113134714975"></p>
<p>这里我把结构复制出来</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">+0x000 Type             : 0n4</span><br><span class="line">+0x002 Size             : 0n168</span><br><span class="line">+0x004 DeviceObject     : (null) </span><br><span class="line">+0x008 Flags            : 2</span><br><span class="line">+0x00c DriverStart      : 0xa6e9c000 Void</span><br><span class="line">+0x010 DriverSize       : 0x6000</span><br><span class="line">+0x014 DriverSection    : 0x860688f0 Void</span><br><span class="line">+0x018 DriverExtension  : 0x860b3530 _DRIVER_EXTENSION</span><br><span class="line">+0x01c DriverName       : _UNICODE_STRING <span class="string">&quot;\Driver\Driver_DL&quot;</span></span><br><span class="line">+0x024 HardwareDatabase : 0x841b7250 _UNICODE_STRING <span class="string">&quot;\REGISTRY\MACHINE\HARDWARE\DESCRIPTION\SYSTEM&quot;</span></span><br><span class="line">+0x028 FastIoDispatch   : (null) </span><br><span class="line">+0x02c DriverInit       : 0xa6ea0000     long  Driver_DL!GsDriverEntry+0</span><br><span class="line">+0x030 DriverStartIo    : (null) </span><br><span class="line">+0x034 DriverUnload     : (null) </span><br><span class="line">+0x038 MajorFunction    : [28] 0x83f00da3     long  nt!IopInvalidDeviceRequest+0</span><br></pre></td></tr></table></figure>
<ul>
<li>0x000 Type （类型）</li>
<li>0x002 Size （结构体大小）</li>
<li>0x004 DeviceObject （设备对象）</li>
<li>0x008 Flags</li>
<li>0x00c DriverStart （驱动模块起始地址）</li>
<li>0x010 DriverSize （驱动大小）</li>
<li>0x014 DriverSection （驱动节）</li>
<li>0x018 DriverExtension （驱动拓展）<ol>
<li>0x000 DriverObject （指向自身驱动）</li>
<li>0x004 AddDevice （设备回调（附加））</li>
<li>0x008 Count （附件了多少个设备）</li>
<li>0x00c ServiceKeyName （启动的服务项（自己的名字））</li>
<li>0x014 ClientDriverExtension (客户端驱动程序扩展)</li>
<li>0x018 FsFilterCallbacks (如果有minifilter将会挂到这)</li>
</ol>
</li>
</ul>
<p><img src="https://gitee.com/ZDDR/blog_img/blob/master/img/x86_kernel_drive/DriverExtension%E9%A9%B1%E5%8A%A8%E6%8B%93%E5%B1%95.png" alt="image-20201113140039020"></p>
<ul>
<li>0x01c DriverName （驱动名字）</li>
<li>0x024 HardwareDatabase （硬件数据库目录）</li>
<li>0x028 FastIoDispatch （驱动通信（不经过IRP））</li>
<li>0x02c DriverInit （初始化函数）</li>
<li>0x030 DriverStartIo （starts the I/O）</li>
<li>0x034 DriverUnload （驱动卸载）</li>
<li>0x038 MajorFunction （驱动通信（经过IRP））</li>
</ul>
<h3 id="DriverSection结构"><a href="#DriverSection结构" class="headerlink" title="DriverSection结构"></a>DriverSection结构</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">NON_PAGED_DEBUG_INFO</span> &#123;</span></span><br><span class="line">	USHORT      Signature;</span><br><span class="line">	USHORT      Flags;</span><br><span class="line">	ULONG       Size;</span><br><span class="line">	USHORT      Machine;</span><br><span class="line">	USHORT      Characteristics;</span><br><span class="line">	ULONG       TimeDateStamp;</span><br><span class="line">	ULONG       CheckSum;</span><br><span class="line">	ULONG       SizeOfImage;</span><br><span class="line">	ULONGLONG   ImageBase;</span><br><span class="line">&#125; NON_PAGED_DEBUG_INFO, * PNON_PAGED_DEBUG_INFO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">KLDR_DATA_TABLE_ENTRY</span> &#123;</span></span><br><span class="line">    LIST_ENTRY InLoadOrderLinks;</span><br><span class="line">    PVOID ExceptionTable;</span><br><span class="line">    ULONG ExceptionTableSize;</span><br><span class="line">    <span class="comment">// ULONG padding on IA64</span></span><br><span class="line">    PVOID GpValue;</span><br><span class="line">    PNON_PAGED_DEBUG_INFO NonPagedDebugInfo;</span><br><span class="line">    PVOID DllBase;</span><br><span class="line">    PVOID EntryPoint;</span><br><span class="line">    ULONG SizeOfImage;</span><br><span class="line">    UNICODE_STRING FullDllName;</span><br><span class="line">    UNICODE_STRING BaseDllName;</span><br><span class="line">    ULONG Flags;</span><br><span class="line">    USHORT LoadCount;</span><br><span class="line">    USHORT __Unused5;</span><br><span class="line">    PVOID SectionPointer;</span><br><span class="line">    ULONG CheckSum;</span><br><span class="line">    <span class="comment">// ULONG padding on IA64</span></span><br><span class="line">    PVOID LoadedImports;</span><br><span class="line">    PVOID PatchInformation;</span><br><span class="line">&#125; KLDR_DATA_TABLE_ENTRY, *PKLDR_DATA_TABLE_ENTRY;</span><br></pre></td></tr></table></figure>
<p>通过WinDbg可以解析出详细信息</p>
<p>如果<code>_KLDR_DATA_TABLE_ENTRY</code>没符号的话使用<code>ld urlmon</code>或<code>ld *</code>下载符号</p>
<p><img src="https://gitee.com/ZDDR/blog_img/raw/master/img/x86_kernel_drive/DriverSection%E7%BB%93%E6%9E%84%E8%AF%A6%E7%BB%86%E4%BF%A1%E6%81%AF.png" alt="image-20201113152653259"></p>
<h2 id="编写代码"><a href="#编写代码" class="headerlink" title="编写代码"></a>编写代码</h2><h3 id="遍历驱动"><a href="#遍历驱动" class="headerlink" title="遍历驱动"></a>遍历驱动</h3><p>DriverSection的0x000 是一个链表，可以通过这个链表遍历出驱动</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">NON_PAGED_DEBUG_INFO</span> &#123;</span></span><br><span class="line">	USHORT      Signature;</span><br><span class="line">	USHORT      Flags;</span><br><span class="line">	ULONG       Size;</span><br><span class="line">	USHORT      Machine;</span><br><span class="line">	USHORT      Characteristics;</span><br><span class="line">	ULONG       TimeDateStamp;</span><br><span class="line">	ULONG       CheckSum;</span><br><span class="line">	ULONG       SizeOfImage;</span><br><span class="line">	ULONGLONG   ImageBase;</span><br><span class="line">&#125; NON_PAGED_DEBUG_INFO, * PNON_PAGED_DEBUG_INFO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">KLDR_DATA_TABLE_ENTRY</span> &#123;</span></span><br><span class="line">	LIST_ENTRY InLoadOrderLinks;</span><br><span class="line">	PVOID ExceptionTable;</span><br><span class="line">	ULONG ExceptionTableSize;</span><br><span class="line">	<span class="comment">// ULONG padding on IA64</span></span><br><span class="line">	PVOID GpValue;</span><br><span class="line">	PNON_PAGED_DEBUG_INFO NonPagedDebugInfo;</span><br><span class="line">	PVOID DllBase;</span><br><span class="line">	PVOID EntryPoint;</span><br><span class="line">	ULONG SizeOfImage;</span><br><span class="line">	UNICODE_STRING FullDllName;</span><br><span class="line">	UNICODE_STRING BaseDllName;</span><br><span class="line">	ULONG Flags;</span><br><span class="line">	USHORT LoadCount;</span><br><span class="line">	USHORT __Unused5;</span><br><span class="line">	PVOID SectionPointer;</span><br><span class="line">	ULONG CheckSum;</span><br><span class="line">	<span class="comment">// ULONG padding on IA64</span></span><br><span class="line">	PVOID LoadedImports;</span><br><span class="line">	PVOID PatchInformation;</span><br><span class="line">&#125; KLDR_DATA_TABLE_ENTRY, * PKLDR_DATA_TABLE_ENTRY;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">DriverUnload</span><span class="params">(PDRIVER_OBJECT pDriver)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	KdPrint((<span class="string">&quot;DriverUnload\r\n&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT pDriver, PUNICODE_STRING pEeg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	PKLDR_DATA_TABLE_ENTRY nextHeader = &amp;((PKLDR_DATA_TABLE_ENTRY)pDriver-&gt;DriverSection)-&gt;InLoadOrderLinks;</span><br><span class="line">	PKLDR_DATA_TABLE_ENTRY nextList = (PKLDR_DATA_TABLE_ENTRY)nextHeader-&gt;InLoadOrderLinks.Flink;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span> (nextHeader != nextList)</span><br><span class="line">	&#123;</span><br><span class="line">		KdPrint((<span class="string">&quot;%wZ\r\n&quot;</span>, &amp;nextList-&gt;FullDllName));</span><br><span class="line">		nextList = (PKLDR_DATA_TABLE_ENTRY)nextList-&gt;InLoadOrderLinks.Flink;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	pDriver-&gt;DriverUnload = DriverUnload;</span><br><span class="line">	KdPrint((<span class="string">&quot;驱动加载成功\r\n&quot;</span>));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="将自己断链"><a href="#将自己断链" class="headerlink" title="将自己断链"></a>将自己断链</h3><p>既然链表可以变量到驱动，那么我们就可以把我们自己的驱动从这个链表中删除，达到隐藏的效果</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">NON_PAGED_DEBUG_INFO</span> &#123;</span></span><br><span class="line">	USHORT      Signature;</span><br><span class="line">	USHORT      Flags;</span><br><span class="line">	ULONG       Size;</span><br><span class="line">	USHORT      Machine;</span><br><span class="line">	USHORT      Characteristics;</span><br><span class="line">	ULONG       TimeDateStamp;</span><br><span class="line">	ULONG       CheckSum;</span><br><span class="line">	ULONG       SizeOfImage;</span><br><span class="line">	ULONGLONG   ImageBase;</span><br><span class="line">&#125; NON_PAGED_DEBUG_INFO, * PNON_PAGED_DEBUG_INFO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">KLDR_DATA_TABLE_ENTRY</span> &#123;</span></span><br><span class="line">	LIST_ENTRY InLoadOrderLinks;</span><br><span class="line">	PVOID ExceptionTable;</span><br><span class="line">	ULONG ExceptionTableSize;</span><br><span class="line">	<span class="comment">// ULONG padding on IA64</span></span><br><span class="line">	PVOID GpValue;</span><br><span class="line">	PNON_PAGED_DEBUG_INFO NonPagedDebugInfo;</span><br><span class="line">	PVOID DllBase;</span><br><span class="line">	PVOID EntryPoint;</span><br><span class="line">	ULONG SizeOfImage;</span><br><span class="line">	UNICODE_STRING FullDllName;</span><br><span class="line">	UNICODE_STRING BaseDllName;</span><br><span class="line">	ULONG Flags;</span><br><span class="line">	USHORT LoadCount;</span><br><span class="line">	USHORT __Unused5;</span><br><span class="line">	PVOID SectionPointer;</span><br><span class="line">	ULONG CheckSum;</span><br><span class="line">	<span class="comment">// ULONG padding on IA64</span></span><br><span class="line">	PVOID LoadedImports;</span><br><span class="line">	PVOID PatchInformation;</span><br><span class="line">&#125; KLDR_DATA_TABLE_ENTRY, * PKLDR_DATA_TABLE_ENTRY;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">workThread</span><span class="params">(PVOID context)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	LARGE_INTEGER large = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	large.QuadPart = <span class="number">-10000</span> * <span class="number">1000</span>;</span><br><span class="line">	KeDelayExecutionThread(KernelMode, TRUE, &amp;large);</span><br><span class="line">	PDRIVER_OBJECT pDriver = (PUNICODE_STRING)context;</span><br><span class="line">	PKLDR_DATA_TABLE_ENTRY nextHeader = &amp;((PKLDR_DATA_TABLE_ENTRY)pDriver-&gt;DriverSection)-&gt;InLoadOrderLinks;</span><br><span class="line">	RemoveEntryList(nextHeader);</span><br><span class="line">	pDriver-&gt;Type = <span class="number">0</span>;</span><br><span class="line">	pDriver-&gt;Size = <span class="number">0</span>;</span><br><span class="line">	pDriver-&gt;DriverSection = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">DriverUnload</span><span class="params">(PDRIVER_OBJECT pDriver)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	KdPrint((<span class="string">&quot;DriverUnload\r\n&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT pDriver, PUNICODE_STRING pEeg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	HANDLE hThread = <span class="literal">NULL</span>;</span><br><span class="line">	PsCreateSystemThread(&amp;hThread, THREAD_ALL_ACCESS, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, workThread, pDriver);</span><br><span class="line"></span><br><span class="line">	pDriver-&gt;DriverUnload = DriverUnload;</span><br><span class="line">	KdPrint((<span class="string">&quot;驱动加载成功\r\n&quot;</span>));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="将别人断链"><a href="#将别人断链" class="headerlink" title="将别人断链"></a>将别人断链</h3><p>还可以把其他驱动从设备中断链</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> POBJECT_TYPE* IoDriverObjectType;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">NON_PAGED_DEBUG_INFO</span> &#123;</span></span><br><span class="line">	USHORT      Signature;</span><br><span class="line">	USHORT      Flags;</span><br><span class="line">	ULONG       Size;</span><br><span class="line">	USHORT      Machine;</span><br><span class="line">	USHORT      Characteristics;</span><br><span class="line">	ULONG       TimeDateStamp;</span><br><span class="line">	ULONG       CheckSum;</span><br><span class="line">	ULONG       SizeOfImage;</span><br><span class="line">	ULONGLONG   ImageBase;</span><br><span class="line">&#125; NON_PAGED_DEBUG_INFO, * PNON_PAGED_DEBUG_INFO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">KLDR_DATA_TABLE_ENTRY</span> &#123;</span></span><br><span class="line">	LIST_ENTRY InLoadOrderLinks;</span><br><span class="line">	PVOID ExceptionTable;</span><br><span class="line">	ULONG ExceptionTableSize;</span><br><span class="line">	<span class="comment">// ULONG padding on IA64</span></span><br><span class="line">	PVOID GpValue;</span><br><span class="line">	PNON_PAGED_DEBUG_INFO NonPagedDebugInfo;</span><br><span class="line">	PVOID DllBase;</span><br><span class="line">	PVOID EntryPoint;</span><br><span class="line">	ULONG SizeOfImage;</span><br><span class="line">	UNICODE_STRING FullDllName;</span><br><span class="line">	UNICODE_STRING BaseDllName;</span><br><span class="line">	ULONG Flags;</span><br><span class="line">	USHORT LoadCount;</span><br><span class="line">	USHORT __Unused5;</span><br><span class="line">	PVOID SectionPointer;</span><br><span class="line">	ULONG CheckSum;</span><br><span class="line">	<span class="comment">// ULONG padding on IA64</span></span><br><span class="line">	PVOID LoadedImports;</span><br><span class="line">	PVOID PatchInformation;</span><br><span class="line">&#125; KLDR_DATA_TABLE_ENTRY, * PKLDR_DATA_TABLE_ENTRY;</span><br><span class="line"></span><br><span class="line">NTSTATUS</span><br><span class="line">ObReferenceObjectByName(</span><br><span class="line">	__in PUNICODE_STRING ObjectName,</span><br><span class="line">	__in ULONG Attributes,</span><br><span class="line">	__in_opt PACCESS_STATE AccessState,</span><br><span class="line">	__in_opt ACCESS_MASK DesiredAccess,</span><br><span class="line">	__in POBJECT_TYPE ObjectType,</span><br><span class="line">	__in KPROCESSOR_MODE AccessMode,</span><br><span class="line">	__inout_opt PVOID ParseContext,</span><br><span class="line">	__out PVOID* Object</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">workThread</span><span class="params">(PVOID context)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	LARGE_INTEGER large = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	large.QuadPart = <span class="number">-10000</span> * <span class="number">1000</span>;</span><br><span class="line">	KeDelayExecutionThread(KernelMode, TRUE, &amp;large);</span><br><span class="line">	PDRIVER_OBJECT pDriver = (PUNICODE_STRING)context;</span><br><span class="line">	PKLDR_DATA_TABLE_ENTRY nextHeader = &amp;((PKLDR_DATA_TABLE_ENTRY)pDriver-&gt;DriverSection)-&gt;InLoadOrderLinks;</span><br><span class="line">	RemoveEntryList(nextHeader);</span><br><span class="line">	pDriver-&gt;Type = <span class="number">0</span>;</span><br><span class="line">	pDriver-&gt;Size = <span class="number">0</span>;</span><br><span class="line">	pDriver-&gt;DriverSection = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">PDRIVER_OBJECT <span class="title">FindDriverObject</span><span class="params">(<span class="keyword">wchar_t</span>* name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UNICODE_STRING DriverName;</span><br><span class="line">	RtlInitUnicodeString(&amp;DriverName, name);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//通过名字引用驱动对象</span></span><br><span class="line">	PDRIVER_OBJECT pDriverObj = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	NTSTATUS status = ObReferenceObjectByName(&amp;DriverName, OBJ_CASE_INSENSITIVE, <span class="literal">NULL</span>, <span class="number">0</span>, *IoDriverObjectType, KernelMode, <span class="literal">NULL</span>, &amp;pDriverObj);</span><br><span class="line">	<span class="keyword">if</span> (!NT_SUCCESS(status))</span><br><span class="line">	&#123;</span><br><span class="line">		KdPrint((<span class="string">&quot;status %x&quot;</span>, status));</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (pDriverObj)</span><br><span class="line">	&#123;</span><br><span class="line">		ObDereferenceObject(pDriverObj);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> pDriverObj;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">DriverUnload</span><span class="params">(PDRIVER_OBJECT pDriver)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	KdPrint((<span class="string">&quot;DriverUnload\r\n&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT pDriver, PUNICODE_STRING pEeg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	PKLDR_DATA_TABLE_ENTRY nextHeader = &amp;((PKLDR_DATA_TABLE_ENTRY)pDriver-&gt;DriverSection)-&gt;InLoadOrderLinks;</span><br><span class="line">	PKLDR_DATA_TABLE_ENTRY nextList = (PKLDR_DATA_TABLE_ENTRY)nextHeader-&gt;InLoadOrderLinks.Flink;</span><br><span class="line"></span><br><span class="line">	UNICODE_STRING DriverName;</span><br><span class="line">	RtlInitUnicodeString(&amp;DriverName, <span class="string">L&quot;tcpipreg.sys&quot;</span>);</span><br><span class="line">	KdPrint((<span class="string">&quot;驱动加载成功\r\n&quot;</span>));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (nextHeader != nextList)</span><br><span class="line">	&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (RtlCompareUnicodeString(&amp;nextList-&gt;BaseDllName, &amp;DriverName, TRUE) == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			</span><br><span class="line">			KdPrint((<span class="string">&quot;%wZ\r\n&quot;</span>, &amp;nextList-&gt;FullDllName));</span><br><span class="line">			PDRIVER_OBJECT p = FindDriverObject(<span class="string">L&quot;\\Driver\\tcpipreg&quot;</span>);</span><br><span class="line">			<span class="keyword">if</span> (p)</span><br><span class="line">			&#123;</span><br><span class="line">				workThread(p);</span><br><span class="line">				KdPrint((<span class="string">&quot;驱动断链成功&quot;</span>));</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		nextList = (PKLDR_DATA_TABLE_ENTRY)nextList-&gt;InLoadOrderLinks.Flink;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	pDriver-&gt;DriverUnload = DriverUnload;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="一个猥琐的东西"><a href="#一个猥琐的东西" class="headerlink" title="一个猥琐的东西"></a>一个猥琐的东西</h3><p>驱动初始化有一个Init段，初始化之后会被释放，可以把这段内存挂上物理页，然后在里面写入shellcode</p>
<p><img src="https://gitee.com/ZDDR/blog_img/raw/master/img/x86_kernel_drive/%E9%A9%B1%E5%8A%A8Init%E6%AE%B5.png" alt="image-20201114124319223"></p>
<p><img src="https://gitee.com/ZDDR/blog_img/raw/master/img/x86_kernel_drive/%E9%A9%B1%E5%8A%A8init%E6%AE%B52.png" alt="image-20201114124648181"></p>
<p><img src="https://gitee.com/ZDDR/blog_img/raw/master/img/x86_kernel_drive/%E6%9F%A5%E7%9C%8Binit%E6%AE%B5%E8%A2%AB%E9%87%8A%E6%94%BE.png" alt="image-20201114124439990"></p>
<h1 id="驱动通信"><a href="#驱动通信" class="headerlink" title="驱动通信"></a>驱动通信</h1><h2 id="如何进行驱动通信"><a href="#如何进行驱动通信" class="headerlink" title="如何进行驱动通信?"></a>如何进行驱动通信?</h2><p><img src="https://gitee.com/ZDDR/blog_img/raw/master/img/x86_kernel_drive/%E9%A9%B1%E5%8A%A8%E9%80%9A%E4%BF%A1%E8%BF%87%E7%A8%8B.png" alt="image-20201120184822102"></p>
<p>在R3下要操作其他进程需要拿到进程句柄，但是驱动对象没有R3句柄，只是描述了整个驱动。只能通过设备进行通信。</p>
<p>一个驱动可以管理多个设备。</p>
<p>驱动通信和minifilter不同的是minifilter为双向通信（ALPC）</p>
<h2 id="使用IoCreateDevice创建一个io设备"><a href="#使用IoCreateDevice创建一个io设备" class="headerlink" title="使用IoCreateDevice创建一个io设备"></a>使用IoCreateDevice创建一个io设备</h2><p>IoCreateDevice定义</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS</span><br><span class="line">IoCreateDevice(</span><br><span class="line">    _In_  PDRIVER_OBJECT DriverObject,						<span class="comment">//由哪一个驱动管理他</span></span><br><span class="line">    _In_  ULONG DeviceExtensionSize,						<span class="comment">//有无自定义的拓展项，默认无</span></span><br><span class="line">    _In_opt_ PUNICODE_STRING DeviceName,					<span class="comment">//设备名</span></span><br><span class="line">    _In_  DEVICE_TYPE DeviceType,							<span class="comment">//设备类型，FILE_DEVICE_UNKNOWN未知对象类型</span></span><br><span class="line">    _In_  ULONG DeviceCharacteristics,						<span class="comment">//FILE_DEVICE_SECURE_OPEN，默认</span></span><br><span class="line">    _In_  BOOLEAN Exclusive,								<span class="comment">//是否独占设备，如果是则一次只能打开一个句柄</span></span><br><span class="line">    _Outptr_result_nullonfailure_</span><br><span class="line">    _At_(*DeviceObject,</span><br><span class="line">        __drv_allocatesMem(Mem)</span><br><span class="line">        _When_((((_In_function_class_(DRIVER_INITIALIZE))</span><br><span class="line">               ||(_In_function_class_(DRIVER_DISPATCH)))),</span><br><span class="line">             __drv_aliasesMem))</span><br><span class="line">    PDEVICE_OBJECT *DeviceObject							<span class="comment">//返回设备对象</span></span><br><span class="line">    );</span><br></pre></td></tr></table></figure>
<p>完成代码</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">DriverUnload</span><span class="params">(PDRIVER_OBJECT pDriver)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	KdPrint((<span class="string">&quot;DriverUnload\r\n&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT pDriver, PUNICODE_STRING pEeg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UNICODE_STRING DeviceName;</span><br><span class="line">	RtlInitUnicodeString(&amp;DeviceName, <span class="string">L&quot;\\Device\\funcHack&quot;</span>);</span><br><span class="line"></span><br><span class="line">	PDRIVER_OBJECT pDevice = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	NTSTATUS status = (pDriver, <span class="literal">NULL</span>, &amp;DeviceName, FILE_DEVICE_UNKNOWN, FILE_DEVICE_SECURE_OPEN, FALSE, &amp;pDevice);</span><br><span class="line">	<span class="keyword">if</span> (!NT_SUCCESS(status))</span><br><span class="line">	&#123;</span><br><span class="line">		KdPrint((<span class="string">&quot;device failed status = %x\r\n&quot;</span>));</span><br><span class="line">		<span class="keyword">return</span> STATUS_DEVICE_HARDWARE_ERROR;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	pDriver-&gt;DriverUnload = DriverUnload;</span><br><span class="line">	KdPrint((<span class="string">&quot;DriverEntry\r\n&quot;</span>));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="创建符号链接让三环访问"><a href="#创建符号链接让三环访问" class="headerlink" title="创建符号链接让三环访问"></a>创建符号链接让三环访问</h2><p>虽然在三环是与设备通信，但是也无法直接访问设备，所以要创建符号链接（类似于快捷方式）让三环访问。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">UNICODE_STRING SymlinkName;</span><br><span class="line">RtlInitUnicodeString(&amp;SymlinkName, <span class="string">L&quot;\\??\\funcHack&quot;</span>);</span><br><span class="line"></span><br><span class="line">status = IoCreateSymbolicLink(&amp;SymlinkName, &amp;DeviceName);</span><br><span class="line"><span class="keyword">if</span> (!NT_SUCCESS(status))</span><br><span class="line">&#123;</span><br><span class="line">	KdPrint((<span class="string">&quot;IoCreateSymbolicLink failed status = %x\r\n&quot;</span>));</span><br><span class="line">	<span class="comment">//如果失败 删除设备</span></span><br><span class="line">	IoDeleteDevice(pDevice);</span><br><span class="line">	<span class="keyword">return</span> STATUS_DEVICE_HARDWARE_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="注册派遣函数"><a href="#注册派遣函数" class="headerlink" title="注册派遣函数"></a>注册派遣函数</h2><p>在说派遣函数之前，需要了解一下什么是<strong>IRP</strong>，</p>
<h2 id="什么是IRP？"><a href="#什么是IRP？" class="headerlink" title="什么是IRP？"></a>什么是IRP？</h2><p>IRP(I/O Request Package)</p>
<p>在windows内核中，有一种系统组件——IRP，即输入输出请求包。</p>
<p>当上层应用程序需要访问底层输入输出设备时，发出I/O请求，系统会把这些请求转化为IRP数据，不同的IRP会启动I/O设备驱动中对应的派遣函数。</p>
<h3 id="IRP的结构"><a href="#IRP的结构" class="headerlink" title="IRP的结构"></a>IRP的结构</h3><p><img src="https://gitee.com/ZDDR/blog_img/raw/master/img/x86_kernel_drive/IRP%E7%9A%84%E7%BB%93%E6%9E%842.png" alt="image-20201115212034243"></p>
<h2 id="MajorFunction派遣函数"><a href="#MajorFunction派遣函数" class="headerlink" title="MajorFunction派遣函数"></a>MajorFunction派遣函数</h2><p>PDRIVER_OBJECT对象中的最后一个成员为MajorFunction</p>
<p>MajorFunction函数的原型</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS</span><br><span class="line">DRIVER_DISPATCH (</span><br><span class="line">    _In_ struct _DEVICE_OBJECT *DeviceObject,</span><br><span class="line">    _Inout_ struct _IRP *Irp</span><br><span class="line">    );</span><br></pre></td></tr></table></figure>
<p>MajorFunction是一个存储着[<a target="_blank" rel="noopener external nofollow noreferrer" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/irp-major-function-codes">IRP Major Function Codes]</a>的数组，这个Code告诉驱动程序应该执行什么操作或底层设备驱动程序来满足I / O请求。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IRP_MJ_CREATE                   0x00		<span class="comment">//打开</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IRP_MJ_CREATE_NAMED_PIPE        0x01		</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IRP_MJ_CLOSE                    0x02		<span class="comment">//结束</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IRP_MJ_READ                     0x03</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IRP_MJ_WRITE                    0x04</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IRP_MJ_QUERY_INFORMATION        0x05</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IRP_MJ_SET_INFORMATION          0x06</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IRP_MJ_QUERY_EA                 0x07</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IRP_MJ_SET_EA                   0x08</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IRP_MJ_FLUSH_BUFFERS            0x09</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IRP_MJ_QUERY_VOLUME_INFORMATION 0x0a</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IRP_MJ_SET_VOLUME_INFORMATION   0x0b</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IRP_MJ_DIRECTORY_CONTROL        0x0c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IRP_MJ_FILE_SYSTEM_CONTROL      0x0d</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IRP_MJ_DEVICE_CONTROL           0x0e</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IRP_MJ_INTERNAL_DEVICE_CONTROL  0x0f</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IRP_MJ_SHUTDOWN                 0x10</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IRP_MJ_LOCK_CONTROL             0x11</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IRP_MJ_CLEANUP                  0x12</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IRP_MJ_CREATE_MAILSLOT          0x13</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IRP_MJ_QUERY_SECURITY           0x14</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IRP_MJ_SET_SECURITY             0x15</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IRP_MJ_POWER                    0x16</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IRP_MJ_SYSTEM_CONTROL           0x17</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IRP_MJ_DEVICE_CHANGE            0x18</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IRP_MJ_QUERY_QUOTA              0x19</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IRP_MJ_SET_QUOTA                0x1a</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IRP_MJ_PNP                      0x1b</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IRP_MJ_PNP_POWER                IRP_MJ_PNP      <span class="comment">// Obsolete....</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IRP_MJ_MAXIMUM_FUNCTION         0x1b</span></span><br></pre></td></tr></table></figure>
<p>IRP常用Code列表</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>描述</th>
<th>调用者</th>
</tr>
</thead>
<tbody><tr>
<td>IRP_MJ_CREATE</td>
<td>请求一个句柄</td>
<td>CreateFile</td>
</tr>
<tr>
<td>IRP_MJ_CLEANUP</td>
<td>在关闭句柄时取消悬挂的IRP</td>
<td>CloseHandle</td>
</tr>
<tr>
<td>IRP_MJ_CLOSE</td>
<td>关闭句柄</td>
<td>CloseHandle</td>
</tr>
<tr>
<td>IRP_MJ_READ</td>
<td>从设备得到数据</td>
<td>ReadFile</td>
</tr>
<tr>
<td>IRP_MJ_WRITE</td>
<td>传送数据到设备</td>
<td>WriteFile</td>
</tr>
<tr>
<td>IRP_MJ_DEVICE_CONTROL</td>
<td>控制操作（利用IOCTL宏）</td>
<td>DeviceIoControl</td>
</tr>
<tr>
<td>RP_MJ_INTERNAL_DEVICE_CONTROL</td>
<td>控制操作(只能被内核调用)</td>
<td>N/A</td>
</tr>
<tr>
<td>IRP_MJ_QUERY_INFORMATION</td>
<td>得到文件的长度</td>
<td>GetFileSize</td>
</tr>
<tr>
<td>IRP_MJ_SET_INFORMATION</td>
<td>设置文件的长度</td>
<td>GetFileSize</td>
</tr>
<tr>
<td>IRP_MJ_FLUSH_BUFFERS</td>
<td>写输出缓冲区或者丢弃输入缓冲区</td>
<td>FlushFileBuffers、FlushConsoleInputBuffer、PurgeComm</td>
</tr>
<tr>
<td>IRP_MJ_SHUTDOWN</td>
<td>系统关闭</td>
<td>InitiateSystemShutdown</td>
</tr>
</tbody></table>
<h2 id="驱动代码"><a href="#驱动代码" class="headerlink" title="驱动代码"></a>驱动代码</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEVICE_NAME <span class="meta-string">L&quot;\\Device\\funcHack&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SYM_NAME <span class="meta-string">L&quot;\\??\\funcHack&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CODE_INDEX 0x800</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CT_TEST CTL_CODE(FILE_DEVICE_UNKNOWN,CODE_INDEX,METHOD_BUFFERED,FILE_ANY_ACCESS)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//默认走这个派发</span></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DefaltDispatch</span><span class="params">(_In_ struct _DEVICE_OBJECT* DeviceObject, _Inout_ struct _IRP* Irp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Irp-&gt;IoStatus.Status = STATUS_SUCCESS; <span class="comment">//这行可以不写 默认为NULL</span></span><br><span class="line">	IoCompleteRequest(Irp, <span class="number">0</span>); <span class="comment">//告诉设备请求完成</span></span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">Dispatch</span><span class="params">(_In_ struct _DEVICE_OBJECT* DeviceObject, _Inout_ struct _IRP* Irp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//获取自己的设备栈</span></span><br><span class="line">	PIO_STACK_LOCATION ioStack = IoGetCurrentIrpStackLocation(Irp);</span><br><span class="line">	<span class="comment">//获取消息码</span></span><br><span class="line">	ULONG IoControlCode = ioStack-&gt;Parameters.DeviceIoControl.IoControlCode;</span><br><span class="line">	<span class="comment">//获取消息长度</span></span><br><span class="line">	ULONG InputBufferLength = ioStack-&gt;Parameters.DeviceIoControl.InputBufferLength;</span><br><span class="line">	<span class="comment">//获取输出参数长度</span></span><br><span class="line">	ULONG OutputBufferLength = ioStack-&gt;Parameters.DeviceIoControl.OutputBufferLength;</span><br><span class="line">	<span class="comment">//获取参数</span></span><br><span class="line">	PVOID inParam = (PVOID)Irp-&gt;AssociatedIrp.SystemBuffer;</span><br><span class="line">	<span class="comment">//解析消息</span></span><br><span class="line">	<span class="keyword">switch</span> (IoControlCode)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">case</span> CT_TEST:</span><br><span class="line">	&#123;</span><br><span class="line">		KdPrint((<span class="string">&quot;%x\r\n&quot;</span>, *(PULONG)inParam));</span><br><span class="line">		*(PULONG)inParam = <span class="number">0x30</span>;</span><br><span class="line">		Irp-&gt;IoStatus.Status = STATUS_SUCCESS;</span><br><span class="line">		Irp-&gt;IoStatus.Information = <span class="number">4</span>;</span><br><span class="line">	&#125;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	IoCompleteRequest(Irp, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">DriverUnload</span><span class="params">(PDRIVER_OBJECT pDriver)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UNICODE_STRING SymlinkName;</span><br><span class="line">	RtlInitUnicodeString(&amp;SymlinkName, SYM_NAME);</span><br><span class="line"></span><br><span class="line">	KdPrint((<span class="string">&quot;DriverUnload\r\n&quot;</span>));</span><br><span class="line">	IoDeleteSymbolicLink(&amp;SymlinkName);</span><br><span class="line">	IoDeleteDevice(pDriver-&gt;DeviceObject);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT pDriver, PUNICODE_STRING pEeg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UNICODE_STRING DeviceName;</span><br><span class="line">	UNICODE_STRING SymlinkName;</span><br><span class="line">	RtlInitUnicodeString(&amp;DeviceName, DEVICE_NAME);</span><br><span class="line">	RtlInitUnicodeString(&amp;SymlinkName, SYM_NAME);</span><br><span class="line">	PDEVICE_OBJECT pDevice = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//创建一个设备</span></span><br><span class="line">	NTSTATUS status = IoCreateDevice(pDriver, <span class="number">0</span>, &amp;DeviceName, FILE_DEVICE_UNKNOWN, FILE_DEVICE_SECURE_OPEN, FALSE, &amp;pDevice);</span><br><span class="line">	<span class="keyword">if</span> (!NT_SUCCESS(status))</span><br><span class="line">	&#123;</span><br><span class="line">		KdPrint((<span class="string">&quot;device failed status = %x\r\n&quot;</span>, status));</span><br><span class="line">		<span class="keyword">return</span> STATUS_DEVICE_HARDWARE_ERROR;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//给设备创建一个R3可识别的名字</span></span><br><span class="line">	status = IoCreateSymbolicLink(&amp;SymlinkName, &amp;DeviceName);</span><br><span class="line">	<span class="keyword">if</span> (!NT_SUCCESS(status))</span><br><span class="line">	&#123;</span><br><span class="line">		KdPrint((<span class="string">&quot;IoCreateSymbolicLink failed status = %x\r\n&quot;</span>, status));</span><br><span class="line">		<span class="comment">//如果失败 删除设备</span></span><br><span class="line">		IoDeleteDevice(pDevice);</span><br><span class="line">		<span class="keyword">return</span> STATUS_DEVICE_HARDWARE_ERROR;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	pDriver-&gt;MajorFunction[IRP_MJ_CREATE] = DefaltDispatch; <span class="comment">//走默认派发</span></span><br><span class="line">	pDriver-&gt;MajorFunction[IRP_MJ_CLOSE] = DefaltDispatch;</span><br><span class="line">	pDriver-&gt;MajorFunction[IRP_MJ_DEVICE_CONTROL] = Dispatch; <span class="comment">//自己的派发</span></span><br><span class="line">	<span class="comment">//设置缓冲io</span></span><br><span class="line">	pDevice-&gt;Flags |= DO_BUFFERED_IO;</span><br><span class="line"></span><br><span class="line">	pDriver-&gt;DriverUnload = DriverUnload;</span><br><span class="line">	KdPrint((<span class="string">&quot;DriverEntry\r\n&quot;</span>));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="R3代码"><a href="#R3代码" class="headerlink" title="R3代码"></a>R3代码</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;winioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SYM_NAME <span class="meta-string">L&quot;\\\\.\\funcHack&quot;</span> <span class="comment">//兼容低版本系统</span></span></span><br><span class="line"><span class="comment">//#define SYM_NAME L&quot;\\??\\funcHack&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CODE_INDEX 0x800</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CT_TEST CTL_CODE(FILE_DEVICE_UNKNOWN,CODE_INDEX,METHOD_BUFFERED,FILE_ANY_ACCESS)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//获取设备句柄</span></span><br><span class="line">   HANDLE hFile =  CreateFile(SYM_NAME, GENERIC_READ | GENERIC_WRITE, <span class="number">0</span>, <span class="literal">NULL</span>, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</span><br><span class="line">   ULONG inLen = <span class="number">100</span>;</span><br><span class="line">   ULONG pro = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">   BOOLEAN is = DeviceIoControl(hFile, CT_TEST, &amp;inLen, <span class="number">4</span>, &amp;inLen, <span class="number">4</span>, &amp;pro, <span class="literal">NULL</span>);</span><br><span class="line">   <span class="keyword">if</span> (is)</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="built_in">printf</span>(<span class="string">&quot;调用成功%x&quot;</span>,inLen);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line">   CloseHandle(hFile);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="劫持设备通信"><a href="#劫持设备通信" class="headerlink" title="劫持设备通信"></a>劫持设备通信</h1><ul>
<li>comm.h</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">COMM_TYPE</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	CMD_TEST = <span class="number">0</span></span><br><span class="line">&#125;COMM_TYPE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">COMMDATA</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	ULONG cmd;</span><br><span class="line">	ULONG reuslt;</span><br><span class="line">	ULONG64 data;</span><br><span class="line">	ULONG64 size;</span><br><span class="line">&#125;COMMDATA,*PCOMMDATA;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(NTAPI* CommCallback)</span><span class="params">(PCOMMDATA data)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOLEAN <span class="title">RegisterComm</span><span class="params">(CommCallback callback)</span></span>;</span><br><span class="line"><span class="function">VOID <span class="title">UnRegisterComm</span><span class="params">(PDRIVER_OBJECT pDriver)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>comm.c</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;comm.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEVICE_NAME <span class="meta-string">L&quot;\\Device\\funcHack&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SYM_NAME <span class="meta-string">L&quot;\\??\\funcHack&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CODE_INDEX 0x800</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CT_TEST CTL_CODE(FILE_DEVICE_UNKNOWN,CODE_INDEX,METHOD_BUFFERED,FILE_ANY_ACCESS)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> POBJECT_TYPE* IoDriverObjectType;</span><br><span class="line"><span class="function">NTKERNELAPI NTSTATUS <span class="title">ObReferenceObjectByName</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">	__in PUNICODE_STRING ObjectName,</span></span></span><br><span class="line"><span class="function"><span class="params">	__in ULONG Attributes,</span></span></span><br><span class="line"><span class="function"><span class="params">	__in_opt PACCESS_STATE AccessState,</span></span></span><br><span class="line"><span class="function"><span class="params">	__in_opt ACCESS_MASK DesiredAccess,</span></span></span><br><span class="line"><span class="function"><span class="params">	__in POBJECT_TYPE ObjectType,</span></span></span><br><span class="line"><span class="function"><span class="params">	__in KPROCESSOR_MODE AccessMode,</span></span></span><br><span class="line"><span class="function"><span class="params">	__inout_opt PVOID ParseContext,</span></span></span><br><span class="line"><span class="function"><span class="params">	__out PVOID* Object</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line">CommCallback gCallBack;</span><br><span class="line">PDRIVER_DISPATCH olDisPath = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//默认走这个派发</span></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DefaltDispatch</span><span class="params">(_In_ struct _DEVICE_OBJECT* DeviceObject, _Inout_ struct _IRP* Irp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Irp-&gt;IoStatus.Status = STATUS_SUCCESS; <span class="comment">//这行可以不写 默认为NULL</span></span><br><span class="line">	IoCompleteRequest(Irp, <span class="number">0</span>); <span class="comment">//告诉设备请求完成</span></span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">Dispatch</span><span class="params">(_In_ struct _DEVICE_OBJECT* DeviceObject, _Inout_ struct _IRP* Irp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	PIO_STACK_LOCATION ioStack = IoGetCurrentIrpStackLocation(Irp);</span><br><span class="line"></span><br><span class="line">	ULONG IoControlCode = ioStack-&gt;Parameters.DeviceIoControl.IoControlCode;</span><br><span class="line">	ULONG InputBufferLength = ioStack-&gt;Parameters.DeviceIoControl.InputBufferLength;</span><br><span class="line">	PVOID inParam = (PVOID)Irp-&gt;AssociatedIrp.SystemBuffer;</span><br><span class="line">	Irp-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">	Irp-&gt;IoStatus.Status = STATUS_NOT_IMPLEMENTED;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (IoControlCode)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">case</span> CT_TEST:</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (InputBufferLength == <span class="keyword">sizeof</span>(COMMDATA))</span><br><span class="line">		&#123;</span><br><span class="line">			PCOMMDATA data = (PCOMMDATA)inParam;</span><br><span class="line">			Irp-&gt;IoStatus.Status = gCallBack(data);</span><br><span class="line">			data-&gt;reuslt = Irp-&gt;IoStatus.Status;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (NT_SUCCESS(Irp-&gt;IoStatus.Status))</span><br><span class="line">	&#123;</span><br><span class="line">		IoCompleteRequest(Irp, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> olDisPath(DeviceObject, Irp);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">PDRIVER_OBJECT <span class="title">FindDriverObject</span><span class="params">(<span class="keyword">wchar_t</span>* name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UNICODE_STRING DriverName;</span><br><span class="line">	RtlInitUnicodeString(&amp;DriverName, name);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//通过名字引用驱动对象</span></span><br><span class="line">	PDRIVER_OBJECT pDriverObj = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	NTSTATUS status = ObReferenceObjectByName(&amp;DriverName, OBJ_CASE_INSENSITIVE, <span class="literal">NULL</span>, <span class="number">0</span>, *IoDriverObjectType, KernelMode, <span class="literal">NULL</span>, &amp;pDriverObj);</span><br><span class="line">	<span class="keyword">if</span> (!NT_SUCCESS(status))</span><br><span class="line">	&#123;</span><br><span class="line">		KdPrint((<span class="string">&quot;status %x&quot;</span>, status));</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (pDriverObj)</span><br><span class="line">	&#123;</span><br><span class="line">		ObDereferenceObject(pDriverObj);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> pDriverObj;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">BOOLEAN <span class="title">RegisterComm</span><span class="params">(CommCallback callback)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (callback == <span class="literal">NULL</span>) <span class="keyword">return</span> FALSE;</span><br><span class="line"></span><br><span class="line">	UNICODE_STRING DeviceName;</span><br><span class="line">	UNICODE_STRING SymlinkName;</span><br><span class="line">	RtlInitUnicodeString(&amp;DeviceName, DEVICE_NAME);</span><br><span class="line">	RtlInitUnicodeString(&amp;SymlinkName, SYM_NAME);</span><br><span class="line">	PDEVICE_OBJECT pDevice = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	PDRIVER_OBJECT pDriver = FindDriverObject(<span class="string">L&quot;\\Driver\\NULL&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (pDriver == <span class="literal">NULL</span>) <span class="keyword">return</span> FALSE;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//保存 卸载后还原</span></span><br><span class="line">	olDisPath = pDriver-&gt;MajorFunction[IRP_MJ_DEVICE_CONTROL];</span><br><span class="line">	pDriver-&gt;MajorFunction[IRP_MJ_DEVICE_CONTROL] = Dispatch; <span class="comment">//自己的派发</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	gCallBack = callback;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">UnRegisterComm</span><span class="params">(PDRIVER_OBJECT pDriver)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	KdPrint((<span class="string">&quot;DriverUnload\r\n&quot;</span>));</span><br><span class="line">	<span class="comment">//卸载的时候还原</span></span><br><span class="line">	PDRIVER_OBJECT pDriver1 = FindDriverObject(<span class="string">L&quot;\\Driver\\NULL&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (pDriver == <span class="literal">NULL</span>) <span class="keyword">return</span> FALSE;</span><br><span class="line">	pDriver1-&gt;MajorFunction[IRP_MJ_DEVICE_CONTROL] = olDisPath;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>main.c</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;comm\comm.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">A</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	ULONG x;</span><br><span class="line">&#125;A;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS NTAPI <span class="title">DisapthCallback</span> <span class="params">(PCOMMDATA data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	NTSTATUS status = STATUS_UNSUCCESSFUL;</span><br><span class="line">	<span class="keyword">switch</span> (data-&gt;cmd)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">case</span> CMD_TEST:</span><br><span class="line">	&#123;</span><br><span class="line">		A* a = (A*)data-&gt;data;</span><br><span class="line">		KdPrint((<span class="string">&quot;%x\r\n&quot;</span>, a-&gt;x));</span><br><span class="line">		status = STATUS_SUCCESS;</span><br><span class="line">	&#125;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">DriverUnload</span><span class="params">(PDRIVER_OBJECT pDriver)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	UnRegisterComm(pDriver);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT pDriver, PUNICODE_STRING pEeg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	pDriver-&gt;DriverUnload = DriverUnload;</span><br><span class="line">	<span class="comment">//RegisterComm(pDriver, DisapthCallback);</span></span><br><span class="line">	RegisterComm(DisapthCallback);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="R3代码-1"><a href="#R3代码-1" class="headerlink" title="R3代码"></a>R3代码</h2><ul>
<li>DriverComm.h</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">COMM_TYPE</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	CMD_TEST = <span class="number">0</span></span><br><span class="line">&#125;COMM_TYPE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">COMMDATA</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	ULONG cmd;</span><br><span class="line">	ULONG reuslt;</span><br><span class="line">	ULONG64 data;</span><br><span class="line">	ULONG64 size;</span><br><span class="line">&#125;COMMDATA, * PCOMMDATA;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOLEAN <span class="title">DriverCommInit</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">BOOLEAN <span class="title">DriverComm</span><span class="params">(COMM_TYPE cmd, PVOID data, ULONG size)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>DriverComm.cpp</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;DriverComm.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SYM_NAME <span class="meta-string">L&quot;\\\\.\\NUL&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CODE_INDEX 0x800</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CT_TEST CTL_CODE(FILE_DEVICE_UNKNOWN,CODE_INDEX,METHOD_BUFFERED,FILE_ANY_ACCESS)</span></span><br><span class="line"></span><br><span class="line">HANDLE hDevice = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOLEAN <span class="title">DriverCommInit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	hDevice = CreateFile(SYM_NAME, GENERIC_READ | GENERIC_WRITE, <span class="number">0</span>, <span class="literal">NULL</span>, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (hDevice == INVALID_HANDLE_VALUE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%s %d\r\n&quot;</span>, __FUNCTION__, GetLastError());</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//不走main函数 在初始化变量的时候调用一下</span></span><br><span class="line"><span class="keyword">int</span> x = DriverCommInit();</span><br><span class="line"></span><br><span class="line"><span class="function">BOOLEAN <span class="title">DriverComm</span><span class="params">(COMM_TYPE cmd, PVOID data, ULONG size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	COMMDATA cmddata;</span><br><span class="line">	cmddata.cmd = cmd;</span><br><span class="line">	cmddata.size = size;</span><br><span class="line">	cmddata.data = (ULONG64)data;</span><br><span class="line">	ULONG pro = <span class="number">0</span>;</span><br><span class="line">	DeviceIoControl(hDevice, CT_TEST, &amp;cmddata, <span class="keyword">sizeof</span>(cmddata), <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;pro, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">return</span> cmddata.reuslt == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>main.cpp</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;winioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;DriverComm.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">A</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	ULONG x;</span><br><span class="line">&#125;A;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	A a = &#123; <span class="number">100</span> &#125;;</span><br><span class="line">	DriverComm(CMD_TEST, &amp;a, <span class="keyword">sizeof</span>(A));</span><br><span class="line">	system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="隐藏驱动通信"><a href="#隐藏驱动通信" class="headerlink" title="隐藏驱动通信"></a>隐藏驱动通信</h1><ul>
<li>comm.h</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">COMM_TYPE</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	CMD_TEST = <span class="number">0</span>,</span><br><span class="line">&#125;COMM_TYPE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">COMMDATA</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	ULONG cmd;</span><br><span class="line">	ULONG reuslt;</span><br><span class="line">	ULONG64 data;</span><br><span class="line">	ULONG64 size;</span><br><span class="line">&#125;COMMDATA,*PCOMMDATA;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">NON_PAGED_DEBUG_INFO</span> &#123;</span></span><br><span class="line">	USHORT      Signature;</span><br><span class="line">	USHORT      Flags;</span><br><span class="line">	ULONG       Size;</span><br><span class="line">	USHORT      Machine;</span><br><span class="line">	USHORT      Characteristics;</span><br><span class="line">	ULONG       TimeDateStamp;</span><br><span class="line">	ULONG       CheckSum;</span><br><span class="line">	ULONG       SizeOfImage;</span><br><span class="line">	ULONGLONG   ImageBase;</span><br><span class="line">&#125; NON_PAGED_DEBUG_INFO, * PNON_PAGED_DEBUG_INFO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">KLDR_DATA_TABLE_ENTRY</span> &#123;</span></span><br><span class="line">	LIST_ENTRY InLoadOrderLinks;</span><br><span class="line">	PVOID ExceptionTable;</span><br><span class="line">	ULONG ExceptionTableSize;</span><br><span class="line">	<span class="comment">// ULONG padding on IA64</span></span><br><span class="line">	PVOID GpValue;</span><br><span class="line">	PNON_PAGED_DEBUG_INFO NonPagedDebugInfo;</span><br><span class="line">	PVOID DllBase;</span><br><span class="line">	PVOID EntryPoint;</span><br><span class="line">	ULONG SizeOfImage;</span><br><span class="line">	UNICODE_STRING FullDllName;</span><br><span class="line">	UNICODE_STRING BaseDllName;</span><br><span class="line">	ULONG Flags;</span><br><span class="line">	USHORT LoadCount;</span><br><span class="line">	USHORT __Unused5;</span><br><span class="line">	PVOID SectionPointer;</span><br><span class="line">	ULONG CheckSum;</span><br><span class="line">	<span class="comment">// ULONG padding on IA64</span></span><br><span class="line">	PVOID LoadedImports;</span><br><span class="line">	PVOID PatchInformation;</span><br><span class="line">&#125; KLDR_DATA_TABLE_ENTRY, * PKLDR_DATA_TABLE_ENTRY;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(NTAPI* CommCallback)</span><span class="params">(PCOMMDATA data)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//BOOLEAN RegisterComm(PDRIVER_OBJECT pDriver, CommCallback callback);</span></span><br><span class="line"><span class="function">BOOLEAN <span class="title">RegisterComm</span><span class="params">(CommCallback callback)</span></span>;</span><br><span class="line"><span class="function">VOID <span class="title">UnRegisterComm</span><span class="params">(PDRIVER_OBJECT pDriver)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>comm.c</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;comm.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;../tools.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEVICE_NAME <span class="meta-string">L&quot;\\Device\\funcHack&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SYM_NAME <span class="meta-string">L&quot;\\??\\funcHack&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CODE_INDEX 0x800</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CT_TEST CTL_CODE(FILE_DEVICE_UNKNOWN,CODE_INDEX,METHOD_BUFFERED,FILE_ANY_ACCESS)</span></span><br><span class="line"></span><br><span class="line">HANDLE hFile = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> POBJECT_TYPE* IoDriverObjectType;</span><br><span class="line"><span class="function">NTKERNELAPI NTSTATUS <span class="title">ObReferenceObjectByName</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">	__in PUNICODE_STRING ObjectName,</span></span></span><br><span class="line"><span class="function"><span class="params">	__in ULONG Attributes,</span></span></span><br><span class="line"><span class="function"><span class="params">	__in_opt PACCESS_STATE AccessState,</span></span></span><br><span class="line"><span class="function"><span class="params">	__in_opt ACCESS_MASK DesiredAccess,</span></span></span><br><span class="line"><span class="function"><span class="params">	__in POBJECT_TYPE ObjectType,</span></span></span><br><span class="line"><span class="function"><span class="params">	__in KPROCESSOR_MODE AccessMode,</span></span></span><br><span class="line"><span class="function"><span class="params">	__inout_opt PVOID ParseContext,</span></span></span><br><span class="line"><span class="function"><span class="params">	__out PVOID* Object</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line">CommCallback gCallBack;</span><br><span class="line">PDRIVER_DISPATCH olDisPath = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//默认走这个派发</span></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DefaltDispatch</span><span class="params">(_In_ struct _DEVICE_OBJECT* DeviceObject, _Inout_ struct _IRP* Irp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Irp-&gt;IoStatus.Status = STATUS_SUCCESS; <span class="comment">//这行可以不写 默认为NULL</span></span><br><span class="line">	IoCompleteRequest(Irp, <span class="number">0</span>); <span class="comment">//告诉设备请求完成</span></span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">Dispatch</span><span class="params">(_In_ struct _DEVICE_OBJECT* DeviceObject, _Inout_ struct _IRP* Irp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	PIO_STACK_LOCATION ioStack = IoGetCurrentIrpStackLocation(Irp);</span><br><span class="line"></span><br><span class="line">	ULONG IoControlCode = ioStack-&gt;Parameters.DeviceIoControl.IoControlCode;</span><br><span class="line">	ULONG InputBufferLength = ioStack-&gt;Parameters.DeviceIoControl.InputBufferLength;</span><br><span class="line">	PVOID inParam = (PVOID)Irp-&gt;AssociatedIrp.SystemBuffer;</span><br><span class="line">	Irp-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">	Irp-&gt;IoStatus.Status = STATUS_NOT_IMPLEMENTED;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (IoControlCode)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">case</span> CT_TEST:</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (InputBufferLength == <span class="keyword">sizeof</span>(COMMDATA))</span><br><span class="line">		&#123;</span><br><span class="line">			PCOMMDATA data = (PCOMMDATA)inParam;</span><br><span class="line">			Irp-&gt;IoStatus.Status = gCallBack(data);</span><br><span class="line">			data-&gt;reuslt = Irp-&gt;IoStatus.Status;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (NT_SUCCESS(Irp-&gt;IoStatus.Status))</span><br><span class="line">	&#123;</span><br><span class="line">		IoCompleteRequest(Irp, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> olDisPath(DeviceObject, Irp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">PDRIVER_OBJECT <span class="title">FindDriverObject</span><span class="params">(<span class="keyword">wchar_t</span>* name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UNICODE_STRING DriverName;</span><br><span class="line">	RtlInitUnicodeString(&amp;DriverName, name);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//通过名字引用驱动对象</span></span><br><span class="line">	PDRIVER_OBJECT pDriverObj = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	NTSTATUS status = ObReferenceObjectByName(&amp;DriverName, OBJ_CASE_INSENSITIVE, <span class="literal">NULL</span>, <span class="number">0</span>, *IoDriverObjectType, KernelMode, <span class="literal">NULL</span>, &amp;pDriverObj);</span><br><span class="line">	<span class="keyword">if</span> (!NT_SUCCESS(status))</span><br><span class="line">	&#123;</span><br><span class="line">		KdPrint((<span class="string">&quot;statuc %x&quot;</span>, status));</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (pDriverObj)</span><br><span class="line">	&#123;</span><br><span class="line">		ObDereferenceObject(pDriverObj);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> pDriverObj;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOLEAN <span class="title">RegisterComm</span><span class="params">(CommCallback callback)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (callback == <span class="literal">NULL</span>) <span class="keyword">return</span> FALSE;</span><br><span class="line"></span><br><span class="line">	UNICODE_STRING DeviceName;</span><br><span class="line">	UNICODE_STRING SymlinkName;</span><br><span class="line">	RtlInitUnicodeString(&amp;DeviceName, DEVICE_NAME);</span><br><span class="line">	RtlInitUnicodeString(&amp;SymlinkName, SYM_NAME);</span><br><span class="line">	PDEVICE_OBJECT pDevice = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	PDRIVER_OBJECT pDriver = FindDriverObject(<span class="string">L&quot;\\Driver\\NULL&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (pDriver == <span class="literal">NULL</span>) <span class="keyword">return</span> FALSE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">//保存 卸载后还原</span></span><br><span class="line">	olDisPath = pDriver-&gt;MajorFunction[IRP_MJ_DEVICE_CONTROL];</span><br><span class="line">    </span><br><span class="line"><span class="comment">/*	</span></span><br><span class="line"><span class="comment">		push ebp	</span></span><br><span class="line"><span class="comment">		mov ebp, esp</span></span><br><span class="line"><span class="comment">		sub esp, 0x40</span></span><br><span class="line"><span class="comment">		push[ebp + c];</span></span><br><span class="line"><span class="comment">		push[ebp + 8]</span></span><br><span class="line"><span class="comment">		push ebx;</span></span><br><span class="line"><span class="comment">		mov eax, 0x1234</span></span><br><span class="line"><span class="comment">		mov ebx, 0x1234</span></span><br><span class="line"><span class="comment">		shl eax, 0x10</span></span><br><span class="line"><span class="comment">		or eax, ebx</span></span><br><span class="line"><span class="comment">		pop ebx</span></span><br><span class="line"><span class="comment">		call eax</span></span><br><span class="line"><span class="comment">		add esp, 0x40</span></span><br><span class="line"><span class="comment">		mov esp, ebp;</span></span><br><span class="line"><span class="comment">		pop ebp;</span></span><br><span class="line"><span class="comment">		ret;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">    </span><br><span class="line">	<span class="keyword">char</span> bufcode[] =</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="number">0x55</span>,</span><br><span class="line">		<span class="number">0x8B</span>,<span class="number">0xEC</span>,</span><br><span class="line">		<span class="number">0x83</span>,<span class="number">0xEC</span>,<span class="number">0x40</span>,</span><br><span class="line">		<span class="number">0xFF</span>,<span class="number">0x75</span>,<span class="number">0x0C</span>,</span><br><span class="line">		<span class="number">0xFF</span>,<span class="number">0x75</span>,<span class="number">0x08</span>,</span><br><span class="line">		<span class="number">0x53</span>,</span><br><span class="line">		<span class="number">0xB8</span>,<span class="number">0x34</span>,<span class="number">0x12</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,</span><br><span class="line">		<span class="number">0xBB</span>,<span class="number">0x34</span>,<span class="number">0x12</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,</span><br><span class="line">		<span class="number">0xC1</span>,<span class="number">0xE0</span>,<span class="number">0x10</span>,</span><br><span class="line">		<span class="number">0x09</span>,<span class="number">0xD8</span>,</span><br><span class="line">		<span class="number">0x5B</span>,</span><br><span class="line">		<span class="number">0xFF</span>,<span class="number">0xD0</span>,</span><br><span class="line">		<span class="number">0x83</span>,<span class="number">0xC4</span>,<span class="number">0x40</span>,</span><br><span class="line">		<span class="number">0x8B</span>,<span class="number">0xE5</span>,</span><br><span class="line">		<span class="number">0x5D</span>,</span><br><span class="line">		<span class="number">0xC2</span>,<span class="number">0x08</span>,<span class="number">0x00</span></span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	ULONG_PTR addr = FindDllSpace(pDriver-&gt;DriverStart, <span class="keyword">sizeof</span>(bufcode));</span><br><span class="line">	KdPrintEx((<span class="number">77</span>, <span class="number">0</span>, <span class="string">&quot;%x\r\n&quot;</span>, addr));</span><br><span class="line">	ULONG_PTR tempAddr = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (addr)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//修复</span></span><br><span class="line">		ULONG_PTR low = (ULONG_PTR)Dispatch &amp; <span class="number">0xFFFF</span>;</span><br><span class="line">		ULONG_PTR hei = ((ULONG_PTR)Dispatch &gt;&gt; <span class="number">0x10</span>) &amp; <span class="number">0xFFFF</span>;</span><br><span class="line">		*(PULONG)&amp;bufcode[<span class="number">14</span>] = hei;</span><br><span class="line">		*(PULONG)&amp;bufcode[<span class="number">19</span>] = low;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//映射</span></span><br><span class="line">		PHYSICAL_ADDRESS phy = MmGetPhysicalAddress(addr);</span><br><span class="line">		PVOID mem = MmMapIoSpace(phy, <span class="keyword">sizeof</span>(bufcode), MmCached);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (mem)</span><br><span class="line">		&#123;</span><br><span class="line"></span><br><span class="line">			<span class="built_in">memcpy</span>(mem, bufcode, <span class="keyword">sizeof</span>(bufcode));</span><br><span class="line">			MmUnmapIoSpace(mem, <span class="keyword">sizeof</span>(bufcode));</span><br><span class="line">			tempAddr = addr;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!tempAddr)</span><br><span class="line">	&#123;</span><br><span class="line">		tempAddr = Dispatch;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	pDriver-&gt;MajorFunction[IRP_MJ_DEVICE_CONTROL] = tempAddr; </span><br><span class="line"></span><br><span class="line">	PKLDR_DATA_TABLE_ENTRY ldr = (PKLDR_DATA_TABLE_ENTRY)pDriver-&gt;DriverSection;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(pDriver-&gt;DriverExtension-&gt;ServiceKeyName.Buffer, <span class="number">0</span>, pDriver-&gt;DriverExtension-&gt;ServiceKeyName.Length);</span><br><span class="line">	pDriver-&gt;DriverExtension-&gt;ServiceKeyName.Length = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ldr)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">memset</span>(ldr-&gt;FullDllName.Buffer, <span class="number">0</span>, ldr-&gt;FullDllName.Length);</span><br><span class="line">		<span class="built_in">memset</span>(ldr-&gt;BaseDllName.Buffer, <span class="number">0</span>, ldr-&gt;BaseDllName.Length);</span><br><span class="line">		ldr-&gt;BaseDllName.Length = <span class="number">0</span>;</span><br><span class="line">		ldr-&gt;FullDllName.Length = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//把文件锁定</span></span><br><span class="line">	hFile = LockFile(<span class="string">L&quot;\\??\\C:\\windows\\system32\\drivers\\NULL.SYS&quot;</span>);</span><br><span class="line">	gCallBack = callback;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">UnRegisterComm</span><span class="params">(PDRIVER_OBJECT pDriver)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	KdPrint((<span class="string">&quot;DriverUnload\r\n&quot;</span>));</span><br><span class="line"></span><br><span class="line">	PDRIVER_OBJECT pDriver1 = FindDriverObject(<span class="string">L&quot;\\Driver\\NULL&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (pDriver == <span class="literal">NULL</span>) <span class="keyword">return</span> FALSE;</span><br><span class="line">	pDriver1-&gt;MajorFunction[IRP_MJ_DEVICE_CONTROL] = olDisPath;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (hFile)NtClose(hFile);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>tools.h</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">MmCopyVirtualMemory</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">	IN PEPROCESS FromProcess,</span></span></span><br><span class="line"><span class="function"><span class="params">	IN CONST VOID* FromAddress,</span></span></span><br><span class="line"><span class="function"><span class="params">	IN PEPROCESS ToProcess,</span></span></span><br><span class="line"><span class="function"><span class="params">	OUT PVOID ToAddress,</span></span></span><br><span class="line"><span class="function"><span class="params">	IN SIZE_T BufferSize,</span></span></span><br><span class="line"><span class="function"><span class="params">	IN KPROCESSOR_MODE PreviousMode,</span></span></span><br><span class="line"><span class="function"><span class="params">	OUT PSIZE_T NumberOfBytesCopied</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">ULONG_PTR <span class="title">FindDllSpace</span><span class="params">(PVOID <span class="keyword">module</span>, ULONG size)</span></span>;</span><br><span class="line"><span class="function">HANDLE <span class="title">LockFile</span><span class="params">(<span class="keyword">wchar_t</span>* Path)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>tools.c</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;tools.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ntimage.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//查找模块中空白的内存用来加载shellcode</span></span><br><span class="line"><span class="function">ULONG_PTR <span class="title">FindDllSpace</span><span class="params">(PVOID <span class="keyword">module</span>, ULONG size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">module</span> == <span class="literal">NULL</span> || size == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)<span class="keyword">module</span>;</span><br><span class="line">	PIMAGE_NT_HEADERS pNts = (PIMAGE_NT_HEADERS)((ULONG_PTR)<span class="keyword">module</span> + pDos-&gt;e_lfanew);</span><br><span class="line">	PIMAGE_SECTION_HEADER pSection = IMAGE_FIRST_SECTION(pNts);</span><br><span class="line">	ULONG_PTR isFind = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">char</span> space[<span class="number">100</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">char</span> space90[<span class="number">100</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">char</span> spaceCc[<span class="number">100</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(space90, <span class="number">0x90</span>, size);</span><br><span class="line">	<span class="built_in">memset</span>(spaceCc, <span class="number">0xcc</span>, size);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pNts-&gt;FileHeader.NumberOfSections; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> ((pSection-&gt;Characteristics &amp; <span class="number">0x20000020</span>))</span><br><span class="line">		&#123;</span><br><span class="line">			PUCHAR pTemp = (PUCHAR)(pSection-&gt;VirtualAddress + (ULONG_PTR)<span class="keyword">module</span>);</span><br><span class="line">			ULONG SectionSize = pSection-&gt;SizeOfRawData;</span><br><span class="line">			PUCHAR pEndTemp = pTemp + SectionSize - size;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">for</span> (; pEndTemp != pTemp; pEndTemp--)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//开始比较</span></span><br><span class="line"></span><br><span class="line">				<span class="comment">//防止物理页被换出 先读一下</span></span><br><span class="line">				ULONG p = <span class="number">0</span>;</span><br><span class="line">				ULONG ret = <span class="number">0</span>;</span><br><span class="line">				NTSTATUS ststau = MmCopyVirtualMemory(PsGetCurrentProcess(), pEndTemp, PsGetCurrentProcess(), &amp;p, <span class="number">4</span>, KernelMode, &amp;ret);</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (!MmIsAddressValid(pEndTemp) || !MmIsAddressValid(pEndTemp + size - <span class="number">1</span>)) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (<span class="built_in">memcmp</span>(pEndTemp, space, size) == <span class="number">0</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					isFind = (ULONG_PTR)pEndTemp;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (<span class="built_in">memcmp</span>(pEndTemp, space90, size) == <span class="number">0</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					isFind = (ULONG_PTR)pEndTemp;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (<span class="built_in">memcmp</span>(pEndTemp, spaceCc, size) == <span class="number">0</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					isFind = (ULONG_PTR)pEndTemp;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (isFind) <span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		pSection++;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> isFind;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//将文件上锁 防止被比对内存检测</span></span><br><span class="line"><span class="function">HANDLE <span class="title">LockFile</span><span class="params">(<span class="keyword">wchar_t</span>* Path)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HANDLE hFile = <span class="literal">NULL</span>;</span><br><span class="line">	OBJECT_ATTRIBUTES obj = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	UNICODE_STRING unFileName = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	RtlInitUnicodeString(&amp;unFileName, Path);</span><br><span class="line">	IO_STATUS_BLOCK IoStack = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	InitializeObjectAttributes(&amp;obj, &amp;unFileName, OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">	ZwCreateFile(&amp;hFile, FILE_ALL_ACCESS, &amp;obj, &amp;IoStack, <span class="literal">NULL</span>, FILE_ATTRIBUTE_NORMAL, <span class="number">0</span>, FILE_OPEN, FILE_NON_DIRECTORY_FILE, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">return</span> hFile;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>DriverMain.c</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;comm\comm.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;tools.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">A</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	ULONG x;</span><br><span class="line">&#125;A;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS NTAPI <span class="title">DisapthCallback</span> <span class="params">(PCOMMDATA data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	NTSTATUS status = STATUS_UNSUCCESSFUL;</span><br><span class="line">	<span class="keyword">switch</span> (data-&gt;cmd)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">case</span> CMD_TEST:</span><br><span class="line">	&#123;</span><br><span class="line">		A* a = (A*)data-&gt;data;</span><br><span class="line">		KdPrint((<span class="string">&quot;%x\r\n&quot;</span>, a-&gt;x));</span><br><span class="line">		status = STATUS_SUCCESS;</span><br><span class="line">	&#125;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">DriverUnload</span><span class="params">(PDRIVER_OBJECT pDriver)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UnRegisterComm(pDriver);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT pDriver, PUNICODE_STRING pEeg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    </span><br><span class="line">	pDriver-&gt;DriverUnload = DriverUnload;</span><br><span class="line">	RegisterComm(DisapthCallback);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="R3代码-2"><a href="#R3代码-2" class="headerlink" title="R3代码"></a>R3代码</h2><ul>
<li>DriverComm.cpp</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;DriverComm.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SYM_NAME <span class="meta-string">L&quot;\\\\.\\NUL&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CODE_INDEX 0x800</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CT_TEST CTL_CODE(FILE_DEVICE_UNKNOWN,CODE_INDEX,METHOD_BUFFERED,FILE_ANY_ACCESS)</span></span><br><span class="line"></span><br><span class="line">HANDLE hDevice = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOLEAN <span class="title">DriverCommInit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	hDevice = CreateFile(SYM_NAME, GENERIC_READ | GENERIC_WRITE, <span class="number">0</span>, <span class="literal">NULL</span>, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (hDevice == INVALID_HANDLE_VALUE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%s %d\r\n&quot;</span>, __FUNCTION__, GetLastError());</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//不走main函数 在初始化变量的时候调用一下</span></span><br><span class="line"><span class="keyword">int</span> x = DriverCommInit();</span><br><span class="line"></span><br><span class="line"><span class="function">BOOLEAN <span class="title">DriverComm</span><span class="params">(COMM_TYPE cmd, PVOID data, ULONG size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	COMMDATA cmddata;</span><br><span class="line">	cmddata.cmd = cmd;</span><br><span class="line">	cmddata.size = size;</span><br><span class="line">	cmddata.data = (ULONG64)data;</span><br><span class="line">	ULONG pro = <span class="number">0</span>;</span><br><span class="line">	DeviceIoControl(hDevice, CT_TEST, &amp;cmddata, <span class="keyword">sizeof</span>(cmddata), <span class="literal">NULL</span>,<span class="literal">NULL</span>, &amp;pro, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">return</span> cmddata.reuslt == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>io_R3.cpp</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;winioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;DriverComm.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">A</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	ULONG x;</span><br><span class="line">&#125;A;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	A a = &#123; <span class="number">100</span> &#125;;</span><br><span class="line">	DriverComm(CMD_TEST, &amp;a, <span class="keyword">sizeof</span>(A));</span><br><span class="line">	system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="驱动随机化"><a href="#驱动随机化" class="headerlink" title="驱动随机化"></a>驱动随机化</h1><p>加入要注入ntdll中，就要获取ntdll的模块地址，获取模块地址，首先想到的是通过PEB获取。</p>
<p>驱动入口是由system进程加载的</p>
<p>首先先让系统断下，查看system进程的CR3</p>
<p><img src="https://gitee.com/ZDDR/blog_img/raw/master/img/x86_kernel_drive/%E6%9F%A5%E7%9C%8Bsystem%E8%BF%9B%E7%A8%8B%E7%9A%84CR3.png" alt="image-20201119180010928"></p>
<p>再看看当前的CR3，可以看到，WinDbg断下时，是断在system进程中</p>
<p><img src="https://gitee.com/ZDDR/blog_img/raw/master/img/x86_kernel_drive/%E5%86%8D%E7%9C%8B%E7%9C%8B%E5%BD%93%E5%89%8D%E7%9A%84CR3.png" alt="image-20201119180107103"></p>
<p>接下来使用<code>dt _EPROCESS</code>查看进程的结构，在<code>0x1a8</code>的位置PEB为NULL</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>: kd&gt; dt _EPROCESS <span class="number">85</span>ed78e8</span><br><span class="line">ntdll!_EPROCESS</span><br><span class="line">   +<span class="number">0x000</span> Pcb              : _KPROCESS</span><br><span class="line">   +<span class="number">0x098</span> ProcessLock      : _EX_PUSH_LOCK</span><br><span class="line">   +<span class="number">0x0a0</span> CreateTime       : _LARGE_INTEGER <span class="number">0x01d6be54</span>`<span class="number">243</span>dfb06</span><br><span class="line">   +<span class="number">0x0a8</span> ExitTime         : _LARGE_INTEGER <span class="number">0x0</span></span><br><span class="line">   +<span class="number">0x0b0</span> RundownProtect   : _EX_RUNDOWN_REF</span><br><span class="line">   +<span class="number">0x0b4</span> UniqueProcessId  : <span class="number">0x00000004</span> Void</span><br><span class="line">   +<span class="number">0x0b8</span> ActiveProcessLinks : _LIST_ENTRY [ <span class="number">0x86a57ae0</span> - <span class="number">0x83f83f18</span> ]</span><br><span class="line">   +<span class="number">0x0c0</span> ProcessQuotaUsage : [<span class="number">2</span>] <span class="number">0</span></span><br><span class="line">   +<span class="number">0x0c8</span> ProcessQuotaPeak : [<span class="number">2</span>] <span class="number">0</span></span><br><span class="line">   +<span class="number">0x0d0</span> CommitCharge     : <span class="number">0xc</span></span><br><span class="line">   +<span class="number">0x0d4</span> QuotaBlock       : <span class="number">0x83f77cc0</span> _EPROCESS_QUOTA_BLOCK</span><br><span class="line">   +<span class="number">0x0d8</span> CpuQuotaBlock    : (null) </span><br><span class="line">   +<span class="number">0x0dc</span> PeakVirtualSize  : <span class="number">0x867000</span></span><br><span class="line">   +<span class="number">0x0e0</span> VirtualSize      : <span class="number">0x2f0000</span></span><br><span class="line">   +<span class="number">0x0e4</span> SessionProcessLinks : _LIST_ENTRY [ <span class="number">0x0</span> - <span class="number">0x0</span> ]</span><br><span class="line">   +<span class="number">0x0ec</span> DebugPort        : (null) </span><br><span class="line">   +<span class="number">0x0f0</span> ExceptionPortData : (null) </span><br><span class="line">   +<span class="number">0x0f0</span> ExceptionPortValue : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x0f0</span> ExceptionPortState : <span class="number">0</span>y000</span><br><span class="line">   +<span class="number">0x0f4</span> ObjectTable      : <span class="number">0x8ae01b28</span> _HANDLE_TABLE</span><br><span class="line">   +<span class="number">0x0f8</span> Token            : _EX_FAST_REF</span><br><span class="line">   +<span class="number">0x0fc</span> WorkingSetPage   : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x100</span> AddressCreationLock : _EX_PUSH_LOCK</span><br><span class="line">   +<span class="number">0x104</span> RotateInProgress : (null) </span><br><span class="line">   +<span class="number">0x108</span> ForkInProgress   : (null) </span><br><span class="line">   +<span class="number">0x10c</span> HardwareTrigger  : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x110</span> PhysicalVadRoot  : <span class="number">0x85eeebd8</span> _MM_AVL_TABLE</span><br><span class="line">   +<span class="number">0x114</span> CloneRoot        : (null) </span><br><span class="line">   +<span class="number">0x118</span> NumberOfPrivatePages : <span class="number">4</span></span><br><span class="line">   +<span class="number">0x11c</span> NumberOfLockedPages : <span class="number">0x40</span></span><br><span class="line">   +<span class="number">0x120</span> Win32Process     : (null) </span><br><span class="line">   +<span class="number">0x124</span> Job              : (null) </span><br><span class="line">   +<span class="number">0x128</span> SectionObject    : (null) </span><br><span class="line">   +<span class="number">0x12c</span> SectionBaseAddress : (null) </span><br><span class="line">   +<span class="number">0x130</span> Cookie           : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x134</span> Spare8           : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x138</span> WorkingSetWatch  : (null) </span><br><span class="line">   +<span class="number">0x13c</span> Win32WindowStation : (null) </span><br><span class="line">   +<span class="number">0x140</span> InheritedFromUniqueProcessId : (null) </span><br><span class="line">   +<span class="number">0x144</span> LdtInformation   : (null) </span><br><span class="line">   +<span class="number">0x148</span> VdmObjects       : (null) </span><br><span class="line">   +<span class="number">0x14c</span> ConsoleHostProcess : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x150</span> DeviceMap        : <span class="number">0x8ae088d8</span> Void</span><br><span class="line">   +<span class="number">0x154</span> EtwDataSource    : (null) </span><br><span class="line">   +<span class="number">0x158</span> FreeTebHint      : <span class="number">0x7ffe0000</span> Void</span><br><span class="line">   +<span class="number">0x160</span> PageDirectoryPte : _HARDWARE_PTE_X86</span><br><span class="line">   +<span class="number">0x160</span> Filler           : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x168</span> Session          : (null) </span><br><span class="line">   +<span class="number">0x16c</span> ImageFileName    : [<span class="number">15</span>]  <span class="string">&quot;System&quot;</span></span><br><span class="line">   +<span class="number">0x17b</span> PriorityClass    : <span class="number">0x2</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">   +0x17c JobLinks         : _LIST_ENTRY [ 0x0 - 0x0 ]</span><br><span class="line">   +<span class="number">0x184</span> LockedPagesList  : (null) </span><br><span class="line">   +<span class="number">0x188</span> ThreadListHead   : _LIST_ENTRY [ <span class="number">0x85ed7878</span> - <span class="number">0x87905510</span> ]</span><br><span class="line">   +<span class="number">0x190</span> SecurityPort     : (null) </span><br><span class="line">   +<span class="number">0x194</span> PaeTop           : <span class="number">0x83f88fc0</span> Void</span><br><span class="line">   +<span class="number">0x198</span> ActiveThreads    : <span class="number">0x5e</span></span><br><span class="line">   +<span class="number">0x19c</span> ImagePathHash    : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x1a0</span> DefaultHardErrorProcessing : <span class="number">1</span></span><br><span class="line">   +<span class="number">0x1a4</span> LastThreadExitStatus : <span class="number">0</span>n0</span><br><span class="line">   +<span class="number">0x1a8</span> Peb              : (null) </span><br><span class="line">   +<span class="number">0x1ac</span> PrefetchTrace    : _EX_FAST_REF</span><br><span class="line">   +<span class="number">0x1b0</span> ReadOperationCount : _LARGE_INTEGER <span class="number">0x45</span></span><br><span class="line">   +<span class="number">0x1b8</span> WriteOperationCount : _LARGE_INTEGER <span class="number">0x8bc</span></span><br><span class="line">   +<span class="number">0x1c0</span> OtherOperationCount : _LARGE_INTEGER <span class="number">0x1920</span></span><br><span class="line">   +<span class="number">0x1c8</span> ReadTransferCount : _LARGE_INTEGER <span class="number">0x2ed7040</span></span><br><span class="line">   +<span class="number">0x1d0</span> WriteTransferCount : _LARGE_INTEGER <span class="number">0xf0a560</span></span><br><span class="line">   +<span class="number">0x1d8</span> OtherTransferCount : _LARGE_INTEGER <span class="number">0x49682</span></span><br><span class="line">   +<span class="number">0x1e0</span> CommitChargeLimit : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x1e4</span> CommitChargePeak : <span class="number">0x31</span></span><br><span class="line">   +<span class="number">0x1e8</span> AweInfo          : (null) </span><br><span class="line">   +<span class="number">0x1ec</span> SeAuditProcessCreationInfo : _SE_AUDIT_PROCESS_CREATION_INFO</span><br><span class="line">   +<span class="number">0x1f0</span> Vm               : _MMSUPPORT</span><br><span class="line">   +<span class="number">0x25c</span> MmProcessLinks   : _LIST_ENTRY [ <span class="number">0x86a57c84</span> - <span class="number">0x83f7689c</span> ]</span><br><span class="line">   +<span class="number">0x264</span> HighestUserAddress : (null) </span><br><span class="line">   +<span class="number">0x268</span> ModifiedPageCount : <span class="number">0xf51ef</span></span><br><span class="line">   +<span class="number">0x26c</span> Flags2           : <span class="number">0x2d800</span></span><br><span class="line">   +<span class="number">0x26c</span> JobNotReallyActive : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x26c</span> AccountingFolded : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x26c</span> NewProcessReported : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x26c</span> ExitProcessReported : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x26c</span> ReportCommitChanges : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x26c</span> LastReportMemory : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x26c</span> ReportPhysicalPageChanges : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x26c</span> HandleTableRundown : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x26c</span> NeedsHandleRundown : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x26c</span> RefTraceEnabled  : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x26c</span> NumaAware        : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x26c</span> ProtectedProcess : <span class="number">0</span>y1</span><br><span class="line">   +<span class="number">0x26c</span> DefaultPagePriority : <span class="number">0</span>y101</span><br><span class="line">   +<span class="number">0x26c</span> PrimaryTokenFrozen : <span class="number">0</span>y1</span><br><span class="line">   +<span class="number">0x26c</span> ProcessVerifierTarget : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x26c</span> StackRandomizationDisabled : <span class="number">0</span>y1</span><br><span class="line">   +<span class="number">0x26c</span> AffinityPermanent : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x26c</span> AffinityUpdateEnable : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x26c</span> PropagateNode    : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x26c</span> ExplicitAffinity : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x270</span> Flags            : <span class="number">0x14040800</span></span><br><span class="line">   +<span class="number">0x270</span> CreateReported   : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x270</span> NoDebugInherit   : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x270</span> ProcessExiting   : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x270</span> ProcessDelete    : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x270</span> Wow64SplitPages  : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x270</span> VmDeleted        : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x270</span> OutswapEnabled   : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x270</span> Outswapped       : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x270</span> ForkFailed       : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x270</span> Wow64VaSpace4Gb  : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x270</span> AddressSpaceInitialized : <span class="number">0</span>y10</span><br><span class="line">   +<span class="number">0x270</span> SetTimerResolution : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x270</span> BreakOnTermination : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x270</span> DeprioritizeViews : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x270</span> WriteWatch       : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x270</span> ProcessInSession : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x270</span> OverrideAddressSpace : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x270</span> HasAddressSpace  : <span class="number">0</span>y1</span><br><span class="line">   +<span class="number">0x270</span> LaunchPrefetched : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x270</span> InjectInpageErrors : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x270</span> VmTopDown        : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x270</span> ImageNotifyDone  : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x270</span> PdeUpdateNeeded  : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x270</span> VdmAllowed       : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x270</span> CrossSessionCreate : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x270</span> ProcessInserted  : <span class="number">0</span>y1</span><br><span class="line">   +<span class="number">0x270</span> DefaultIoPriority : <span class="number">0</span>y010</span><br><span class="line">   +<span class="number">0x270</span> ProcessSelfDelete : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x270</span> SetTimerResolutionLink : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x274</span> ExitStatus       : <span class="number">0</span>n259</span><br><span class="line">   +<span class="number">0x278</span> VadRoot          : _MM_AVL_TABLE</span><br><span class="line">   +<span class="number">0x298</span> AlpcContext      : _ALPC_PROCESS_CONTEXT</span><br><span class="line">   +<span class="number">0x2a8</span> TimerResolutionLink : _LIST_ENTRY [ <span class="number">0x0</span> - <span class="number">0x0</span> ]</span><br><span class="line">   +<span class="number">0x2b0</span> RequestedTimerResolution : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x2b4</span> ActiveThreadsHighWatermark : <span class="number">0x61</span></span><br><span class="line">   +<span class="number">0x2b8</span> SmallestTimerResolution : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x2bc</span> TimerResolutionStackRecord : (null) </span><br></pre></td></tr></table></figure>
<p>这就说明了，无法通过PEB来获取模块地址，接下来剩下两个方案</p>
<p>1.遍历进程</p>
<p>2.设置回调(在Windows内核中，加载的每一个dll或者驱动，都可以通过一个回调拦截下来)</p>
<p>这里先说进程遍历的方式</p>
<p>遍历进程又有几套方案，通过短名字、长名字</p>
<p>win7 32的短名字在进程结构中的0x16c的位置，这个名字最大为15个字符，如果进程名太长则无法使用这种方式</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x16c</span> ImageFileName : [<span class="number">15</span>] <span class="string">&quot;System&quot;</span></span><br></pre></td></tr></table></figure>
<p>长名在0x1ec的结构中</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x1ec</span> SeAuditProcessCreationInfo : _SE_AUDIT_PROCESS_CREATION_INFO</span><br></pre></td></tr></table></figure>
<p>使用<code>-r1</code>查看该结构</p>
<p><img src="https://gitee.com/ZDDR/blog_img/raw/master/img/x86_kernel_drive/SE_AUDIT_PROCESS_CREATION_INFO.png" alt="image-20201119210347585"></p>
<p>再使用<code>dt</code>查看该结构,发现system没有长名（全路径）</p>
<p><img src="https://gitee.com/ZDDR/blog_img/raw/master/img/x86_kernel_drive/OBJECT_NAME_INFORMATION.png" alt="image-20201119211145882"></p>
<ul>
<li>tools.h</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">MmCopyVirtualMemory</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">	IN PEPROCESS FromProcess,</span></span></span><br><span class="line"><span class="function"><span class="params">	IN CONST VOID* FromAddress,</span></span></span><br><span class="line"><span class="function"><span class="params">	IN PEPROCESS ToProcess,</span></span></span><br><span class="line"><span class="function"><span class="params">	OUT PVOID ToAddress,</span></span></span><br><span class="line"><span class="function"><span class="params">	IN SIZE_T BufferSize,</span></span></span><br><span class="line"><span class="function"><span class="params">	IN KPROCESSOR_MODE PreviousMode,</span></span></span><br><span class="line"><span class="function"><span class="params">	OUT PSIZE_T NumberOfBytesCopied</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">EXTERN_C PVOID NTAPI <span class="title">PsGetProcessPeb</span><span class="params">(PEPROCESS Process)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">PEB_LDR_DATA</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	ULONG Length;                                                           <span class="comment">//0x0</span></span><br><span class="line">	UCHAR Initialized;                                                      <span class="comment">//0x4</span></span><br><span class="line">	VOID* SsHandle;                                                         <span class="comment">//0x8</span></span><br><span class="line">	LIST_ENTRY InLoadOrderModuleList;                               <span class="comment">//0xc</span></span><br><span class="line">	LIST_ENTRY InMemoryOrderModuleList;                             <span class="comment">//0x14</span></span><br><span class="line">	LIST_ENTRY InInitializationOrderModuleList;                     <span class="comment">//0x1c</span></span><br><span class="line">	VOID* EntryInProgress;                                                  <span class="comment">//0x24</span></span><br><span class="line">	UCHAR ShutdownInProgress;                                               <span class="comment">//0x28</span></span><br><span class="line">	VOID* ShutdownThreadId;                                                 <span class="comment">//0x2c</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">LDR_DATA_TABLE_ENTRY</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	LIST_ENTRY InLoadOrderLinks;                                    <span class="comment">//0x0</span></span><br><span class="line">	LIST_ENTRY InMemoryOrderLinks;                                  <span class="comment">//0x8</span></span><br><span class="line">	LIST_ENTRY InInitializationOrderLinks;                          <span class="comment">//0x10</span></span><br><span class="line">	VOID* DllBase;                                                          <span class="comment">//0x18</span></span><br><span class="line">	VOID* EntryPoint;                                                       <span class="comment">//0x1c</span></span><br><span class="line">	ULONG SizeOfImage;                                                      <span class="comment">//0x20</span></span><br><span class="line">	UNICODE_STRING FullDllName;                                     <span class="comment">//0x24</span></span><br><span class="line">	UNICODE_STRING BaseDllName;                                     <span class="comment">//0x2c</span></span><br><span class="line">	ULONG Flags;                                                            <span class="comment">//0x34</span></span><br><span class="line">	USHORT LoadCount;                                                       <span class="comment">//0x38</span></span><br><span class="line">	USHORT TlsIndex;                                                        <span class="comment">//0x3a</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">	&#123;</span></span><br><span class="line">		LIST_ENTRY HashLinks;                                       <span class="comment">//0x3c</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">		&#123;</span></span><br><span class="line">			VOID* SectionPointer;                                           <span class="comment">//0x3c</span></span><br><span class="line">			ULONG CheckSum;                                                 <span class="comment">//0x40</span></span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">	&#123;</span></span><br><span class="line">		ULONG TimeDateStamp;                                                <span class="comment">//0x44</span></span><br><span class="line">		VOID* LoadedImports;                                                <span class="comment">//0x44</span></span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> _<span class="title">ACTIVATION_CONTEXT</span>* <span class="title">EntryPointActivationContext</span>;</span>                <span class="comment">//0x48</span></span><br><span class="line">	VOID* PatchInformation;                                                 <span class="comment">//0x4c</span></span><br><span class="line">	LIST_ENTRY ForwarderLinks;                                      <span class="comment">//0x50</span></span><br><span class="line">	LIST_ENTRY ServiceTagLinks;                                     <span class="comment">//0x58</span></span><br><span class="line">	LIST_ENTRY StaticLinks;                                         <span class="comment">//0x60</span></span><br><span class="line">	VOID* ContextInformation;                                               <span class="comment">//0x68</span></span><br><span class="line">	ULONG OriginalBase;                                                     <span class="comment">//0x6c</span></span><br><span class="line">	LARGE_INTEGER LoadTime;                                          <span class="comment">//0x70</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">ULONG_PTR <span class="title">FindDllSpace</span><span class="params">(PVOID <span class="keyword">module</span>, ULONG size)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">HANDLE <span class="title">LockFile</span><span class="params">(<span class="keyword">wchar_t</span>* Path)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">PEPROCESS <span class="title">GetProcessByName</span><span class="params">(<span class="keyword">wchar_t</span>* ProcessName)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">ULONG_PTR <span class="title">GetDllModule</span><span class="params">(PEPROCESS process, <span class="keyword">wchar_t</span>* MoudleName)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>tools.c</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;tools.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ntimage.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">ULONG_PTR <span class="title">FindDllSpace</span><span class="params">(PVOID <span class="keyword">module</span>, ULONG size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">module</span> == <span class="literal">NULL</span> || size == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)<span class="keyword">module</span>;</span><br><span class="line">	PIMAGE_NT_HEADERS pNts = (PIMAGE_NT_HEADERS)((ULONG_PTR)<span class="keyword">module</span> + pDos-&gt;e_lfanew);</span><br><span class="line">	PIMAGE_SECTION_HEADER pSection = IMAGE_FIRST_SECTION(pNts);</span><br><span class="line">	ULONG_PTR isFind = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">char</span> space[<span class="number">100</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">char</span> space90[<span class="number">100</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">char</span> spaceCc[<span class="number">100</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(space90, <span class="number">0x90</span>, size);</span><br><span class="line">	<span class="built_in">memset</span>(spaceCc, <span class="number">0xcc</span>, size);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pNts-&gt;FileHeader.NumberOfSections; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> ((pSection-&gt;Characteristics &amp; <span class="number">0x60000020</span>) == <span class="number">0x60000020</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			PUCHAR pTemp = (PUCHAR)(pSection-&gt;VirtualAddress + (ULONG_PTR)<span class="keyword">module</span>);</span><br><span class="line">			ULONG SectionSize = pSection-&gt;SizeOfRawData;</span><br><span class="line">			PUCHAR pEndTemp = pTemp + SectionSize - size;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">for</span> (; pEndTemp != pTemp; pEndTemp--)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//开始比较</span></span><br><span class="line"></span><br><span class="line">				<span class="comment">//防止物理页被换出 先读一下</span></span><br><span class="line">				ULONG p = <span class="number">0</span>;</span><br><span class="line">				ULONG ret = <span class="number">0</span>;</span><br><span class="line">				NTSTATUS ststau = MmCopyVirtualMemory(PsGetCurrentProcess(), pEndTemp, PsGetCurrentProcess(), &amp;p, <span class="number">4</span>, KernelMode, &amp;ret);</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (!MmIsAddressValid(pEndTemp) || !MmIsAddressValid(pEndTemp + size - <span class="number">1</span>)) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (<span class="built_in">memcmp</span>(pEndTemp, space, size) == <span class="number">0</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					isFind = (ULONG_PTR)pEndTemp;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (<span class="built_in">memcmp</span>(pEndTemp, space90, size) == <span class="number">0</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					isFind = (ULONG_PTR)pEndTemp;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (<span class="built_in">memcmp</span>(pEndTemp, spaceCc, size) == <span class="number">0</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					isFind = (ULONG_PTR)pEndTemp;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (isFind) <span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		pSection++;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> isFind;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">HANDLE <span class="title">LockFile</span><span class="params">(<span class="keyword">wchar_t</span>* Path)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HANDLE hFile = <span class="literal">NULL</span>;</span><br><span class="line">	OBJECT_ATTRIBUTES obj = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	UNICODE_STRING unFileName = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	RtlInitUnicodeString(&amp;unFileName, Path);</span><br><span class="line">	IO_STATUS_BLOCK IoStack = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	InitializeObjectAttributes(&amp;obj, &amp;unFileName, OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">	ZwCreateFile(&amp;hFile, FILE_ALL_ACCESS, &amp;obj, &amp;IoStack, <span class="literal">NULL</span>, FILE_ATTRIBUTE_NORMAL, <span class="number">0</span>, FILE_OPEN, FILE_NON_DIRECTORY_FILE, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">return</span> hFile;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">PEPROCESS <span class="title">GetProcessByName</span><span class="params">(<span class="keyword">wchar_t</span>* ProcessName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!ProcessName || ProcessName[<span class="number">0</span>] == <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	PEPROCESS RetEprocess = <span class="literal">NULL</span>;</span><br><span class="line">	INT len = wcslen(ProcessName) * <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">wchar_t</span> * pName = ExAllocatePool(PagedPool, len + <span class="number">2</span>);</span><br><span class="line">	<span class="built_in">memset</span>(pName, <span class="number">0</span>, len + <span class="number">2</span>);</span><br><span class="line">	<span class="built_in">memcpy</span>(pName, ProcessName, len);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">8</span>; i &lt; <span class="number">100000</span>; i += <span class="number">4</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		PEPROCESS eprocess = <span class="literal">NULL</span>;</span><br><span class="line">		NTSTATUS status = PsLookupProcessByProcessId((HANDLE)i, &amp;eprocess);</span><br><span class="line">		<span class="keyword">if</span> (!NT_SUCCESS(status))<span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">		PUNICODE_STRING unProcessName;</span><br><span class="line">		status = SeLocateProcessImageName(eprocess, &amp;unProcessName);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!NT_SUCCESS(status))</span><br><span class="line">		&#123;</span><br><span class="line">			ObDereferenceObject(eprocess);</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (wcsstr(unProcessName-&gt;Buffer, pName))</span><br><span class="line">		&#123;</span><br><span class="line">			RetEprocess = eprocess;</span><br><span class="line">			<span class="comment">//ExFreePoolWithTag释放通过ExAllocatePoolWithTag申请的指定标签分配池内存块</span></span><br><span class="line">			ExFreePoolWithTag(unProcessName, &#x27;fIeS&#x27;);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		ExFreePoolWithTag(unProcessName, &#x27;fIeS&#x27;);</span><br><span class="line">	&#125;</span><br><span class="line">	ExFreePool(pName);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> RetEprocess;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ULONG_PTR <span class="title">GetDllModule</span><span class="params">(PEPROCESS process, <span class="keyword">wchar_t</span>* MoudleName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!process || MoudleName == <span class="literal">NULL</span>)<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	ULONG_PTR moudleAddr = <span class="number">0</span>;</span><br><span class="line">	PUCHAR peb = (PUCHAR)PsGetProcessPeb(process);</span><br><span class="line">	<span class="keyword">if</span> (peb == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	KAPC_STATE kApcState = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	KeStackAttachProcess(process, &amp;kApcState);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">do</span> </span><br><span class="line">	&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> _<span class="title">PEB_LDR_DATA</span>* <span class="title">pldr</span> =</span> (struct _PEB_LDR_DATA*)(*(PULONG)(peb + <span class="number">0xc</span>));</span><br><span class="line">		<span class="keyword">if</span> (!pldr) <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> _<span class="title">LDR_DATA_TABLE_ENTRY</span>* <span class="title">list</span> =</span> (struct _LDR_DATA_TABLE_ENTRY*)&amp;pldr-&gt;InLoadOrderModuleList.Flink;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> _<span class="title">LDR_DATA_TABLE_ENTRY</span>* <span class="title">nextList</span> =</span> <span class="built_in">list</span>-&gt;InLoadOrderLinks.Flink;</span><br><span class="line">		<span class="keyword">while</span> (<span class="built_in">list</span> != nextList)</span><br><span class="line">		&#123;</span><br><span class="line">			__try</span><br><span class="line">			&#123;</span><br><span class="line">				ProbeForRead(nextList, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">				<span class="keyword">if</span> (nextList-&gt;BaseDllName.Length &amp;&amp; wcsstr(nextList-&gt;BaseDllName.Buffer,MoudleName))</span><br><span class="line">				&#123;</span><br><span class="line">					moudleAddr = (ULONG_PTR)nextList-&gt;DllBase;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			__except (<span class="number">1</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				nextList = nextList-&gt;InLoadOrderLinks.Flink;</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			nextList = nextList-&gt;InLoadOrderLinks.Flink;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">while</span> (<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	KeUnstackDetachProcess(&amp;kApcState);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> moudleAddr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>comm.h</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ntimage.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">COMM_TYPE</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	CMD_TEST = <span class="number">0</span>,</span><br><span class="line">&#125;COMM_TYPE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">COMMDATA</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	ULONG cmd;</span><br><span class="line">	ULONG reuslt;</span><br><span class="line">	ULONG64 data;</span><br><span class="line">	ULONG64 size;</span><br><span class="line">&#125;COMMDATA,*PCOMMDATA;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">KLDR_DATA_TABLE_ENTRY</span> &#123;</span></span><br><span class="line">	LIST_ENTRY InLoadOrderLinks;</span><br><span class="line">	PVOID ExceptionTable;</span><br><span class="line">	ULONG ExceptionTableSize;</span><br><span class="line">	<span class="comment">// ULONG padding on IA64</span></span><br><span class="line">	PVOID GpValue;</span><br><span class="line">	PNON_PAGED_DEBUG_INFO NonPagedDebugInfo;</span><br><span class="line">	PVOID DllBase;</span><br><span class="line">	PVOID EntryPoint;</span><br><span class="line">	ULONG SizeOfImage;</span><br><span class="line">	UNICODE_STRING FullDllName;</span><br><span class="line">	UNICODE_STRING BaseDllName;</span><br><span class="line">	ULONG Flags;</span><br><span class="line">	USHORT LoadCount;</span><br><span class="line">	USHORT __Unused5;</span><br><span class="line">	PVOID SectionPointer;</span><br><span class="line">	ULONG CheckSum;</span><br><span class="line">	<span class="comment">// ULONG padding on IA64</span></span><br><span class="line">	PVOID LoadedImports;</span><br><span class="line">	PVOID PatchInformation;</span><br><span class="line">&#125; KLDR_DATA_TABLE_ENTRY, * PKLDR_DATA_TABLE_ENTRY;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(NTAPI* CommCallback)</span><span class="params">(PCOMMDATA data)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//BOOLEAN RegisterComm(PDRIVER_OBJECT pDriver, CommCallback callback);</span></span><br><span class="line"><span class="function">BOOLEAN <span class="title">RegisterComm</span><span class="params">(CommCallback callback)</span></span>;</span><br><span class="line"><span class="function">VOID <span class="title">UnRegisterComm</span><span class="params">(PDRIVER_OBJECT pDriver)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>comm.c</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;comm.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;../tools.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ntstrsafe.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEVICE_NAME <span class="meta-string">L&quot;\\Device\\Nul&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SYM_NAME <span class="meta-string">L&quot;\\??\\funcHack&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CODE_INDEX 0x800</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CT_TEST CTL_CODE(FILE_DEVICE_UNKNOWN,CODE_INDEX,METHOD_BUFFERED,FILE_ANY_ACCESS)</span></span><br><span class="line"></span><br><span class="line">HANDLE hFile = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> POBJECT_TYPE* IoDriverObjectType;</span><br><span class="line"><span class="function">NTKERNELAPI NTSTATUS <span class="title">ObReferenceObjectByName</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">	__in PUNICODE_STRING ObjectName,</span></span></span><br><span class="line"><span class="function"><span class="params">	__in ULONG Attributes,</span></span></span><br><span class="line"><span class="function"><span class="params">	__in_opt PACCESS_STATE AccessState,</span></span></span><br><span class="line"><span class="function"><span class="params">	__in_opt ACCESS_MASK DesiredAccess,</span></span></span><br><span class="line"><span class="function"><span class="params">	__in POBJECT_TYPE ObjectType,</span></span></span><br><span class="line"><span class="function"><span class="params">	__in KPROCESSOR_MODE AccessMode,</span></span></span><br><span class="line"><span class="function"><span class="params">	__inout_opt PVOID ParseContext,</span></span></span><br><span class="line"><span class="function"><span class="params">	__out PVOID* Object</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line">CommCallback gCallBack;</span><br><span class="line">PDRIVER_DISPATCH olDisPath = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">PUNICODE_STRING <span class="title">GetSymRandName</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//&quot;\\??\\xxxxxxxxx&quot;</span></span><br><span class="line">	PUNICODE_STRING unName = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">if</span> (unName != <span class="number">0</span>)<span class="keyword">return</span> unName;</span><br><span class="line"></span><br><span class="line">	unName = ExAllocatePool(PagedPool, <span class="keyword">sizeof</span>(UNICODE_STRING));</span><br><span class="line"></span><br><span class="line">	LARGE_INTEGER currentTime;</span><br><span class="line">	KeQuerySystemTime(&amp;currentTime);</span><br><span class="line">	ULONG randNumber1 = RtlRandomEx(&amp;currentTime.LowPart);</span><br><span class="line">	ULONG randNumber2 = RtlRandomEx(&amp;currentTime.LowPart);</span><br><span class="line">	<span class="keyword">wchar_t</span> bufName[<span class="number">100</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	RtlStringCbPrintfW(bufName, <span class="number">100</span> * <span class="keyword">sizeof</span>(<span class="keyword">wchar_t</span>), <span class="string">L&quot;\\??\\%x%x&quot;</span>, randNumber1, randNumber2);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> len = wcslen(bufName) * <span class="number">2</span>;<span class="comment">//求字符个数 宽字符x2</span></span><br><span class="line">	unName-&gt;Buffer = ExAllocatePool(PagedPool, len + <span class="number">2</span>);<span class="comment">//使用分页内存  不需要可执行</span></span><br><span class="line">	unName-&gt;Length = len;</span><br><span class="line">	unName-&gt;MaximumLength = len + <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(unName-&gt;Buffer, <span class="number">0</span>, len + <span class="number">2</span>);</span><br><span class="line">	<span class="built_in">memcpy</span>(unName-&gt;Buffer, bufName, len);</span><br><span class="line">	<span class="keyword">return</span> unName;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//默认走这个派发</span></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DefaltDispatch</span><span class="params">(_In_ struct _DEVICE_OBJECT* DeviceObject, _Inout_ struct _IRP* Irp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Irp-&gt;IoStatus.Status = STATUS_SUCCESS; <span class="comment">//这行可以不写 默认为NULL</span></span><br><span class="line">	IoCompleteRequest(Irp, <span class="number">0</span>); <span class="comment">//告诉设备请求完成</span></span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">Dispatch</span><span class="params">(_In_ struct _DEVICE_OBJECT* DeviceObject, _Inout_ struct _IRP* Irp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	PIO_STACK_LOCATION ioStack = IoGetCurrentIrpStackLocation(Irp);</span><br><span class="line"></span><br><span class="line">	ULONG IoControlCode = ioStack-&gt;Parameters.DeviceIoControl.IoControlCode;</span><br><span class="line">	ULONG InputBufferLength = ioStack-&gt;Parameters.DeviceIoControl.InputBufferLength;</span><br><span class="line">	PVOID inParam = (PVOID)Irp-&gt;AssociatedIrp.SystemBuffer;</span><br><span class="line">	Irp-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">	Irp-&gt;IoStatus.Status = STATUS_NOT_IMPLEMENTED;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (IoControlCode)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">case</span> CT_TEST:</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (InputBufferLength == <span class="keyword">sizeof</span>(COMMDATA))</span><br><span class="line">		&#123;</span><br><span class="line">			PCOMMDATA data = (PCOMMDATA)inParam;</span><br><span class="line">			Irp-&gt;IoStatus.Status = gCallBack(data);</span><br><span class="line">			data-&gt;reuslt = Irp-&gt;IoStatus.Status;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (NT_SUCCESS(Irp-&gt;IoStatus.Status))</span><br><span class="line">	&#123;</span><br><span class="line">		IoCompleteRequest(Irp, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> olDisPath(DeviceObject, Irp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">PDRIVER_OBJECT <span class="title">FindDriverObject</span><span class="params">(<span class="keyword">wchar_t</span>* name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UNICODE_STRING DriverName;</span><br><span class="line">	RtlInitUnicodeString(&amp;DriverName, name);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//通过名字引用驱动对象</span></span><br><span class="line">	PDRIVER_OBJECT pDriverObj = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	NTSTATUS status = ObReferenceObjectByName(&amp;DriverName, OBJ_CASE_INSENSITIVE, <span class="literal">NULL</span>, <span class="number">0</span>, *IoDriverObjectType, KernelMode, <span class="literal">NULL</span>, &amp;pDriverObj);</span><br><span class="line">	<span class="keyword">if</span> (!NT_SUCCESS(status))</span><br><span class="line">	&#123;</span><br><span class="line">		KdPrint((<span class="string">&quot;statuc %x&quot;</span>, status));</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (pDriverObj)</span><br><span class="line">	&#123;</span><br><span class="line">		ObDereferenceObject(pDriverObj);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> pDriverObj;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">BOOLEAN <span class="title">RegisterComm</span><span class="params">(CommCallback callback)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (callback == <span class="literal">NULL</span>) <span class="keyword">return</span> FALSE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	NTSTATUS status = STATUS_UNSUCCESSFUL;</span><br><span class="line">	UNICODE_STRING DeviceName;</span><br><span class="line">	RtlInitUnicodeString(&amp;DeviceName, DEVICE_NAME);</span><br><span class="line"></span><br><span class="line">	PUNICODE_STRING unRandName = GetSymRandName();</span><br><span class="line">	KdPrintEx((<span class="number">77</span>, <span class="number">0</span>, <span class="string">&quot;unRandName = %wZ\r\n&quot;</span>, unRandName));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	PDRIVER_OBJECT pDriver = FindDriverObject(<span class="string">L&quot;\\Driver\\NULL&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (pDriver == <span class="literal">NULL</span>) <span class="keyword">return</span> FALSE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">//保存 卸载后还原</span></span><br><span class="line">	olDisPath = pDriver-&gt;MajorFunction[IRP_MJ_DEVICE_CONTROL];</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*	</span></span><br><span class="line"><span class="comment">		push ebp	</span></span><br><span class="line"><span class="comment">		mov ebp, esp</span></span><br><span class="line"><span class="comment">		sub esp, 0x40</span></span><br><span class="line"><span class="comment">		push[ebp + c];</span></span><br><span class="line"><span class="comment">		push[ebp + 8]</span></span><br><span class="line"><span class="comment">		push ebx;</span></span><br><span class="line"><span class="comment">		mov eax, 0x1234</span></span><br><span class="line"><span class="comment">		mov ebx, 0x1234</span></span><br><span class="line"><span class="comment">		shl eax, 0x10</span></span><br><span class="line"><span class="comment">		or eax, ebx</span></span><br><span class="line"><span class="comment">		pop ebx</span></span><br><span class="line"><span class="comment">		call eax</span></span><br><span class="line"><span class="comment">		add esp, 0x40</span></span><br><span class="line"><span class="comment">		mov esp, ebp;</span></span><br><span class="line"><span class="comment">		pop ebp;</span></span><br><span class="line"><span class="comment">		ret;</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="keyword">char</span> bufcode[] =</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="number">0x55</span>,</span><br><span class="line">		<span class="number">0x8B</span>,<span class="number">0xEC</span>,</span><br><span class="line">		<span class="number">0x83</span>,<span class="number">0xEC</span>,<span class="number">0x40</span>,</span><br><span class="line">		<span class="number">0xFF</span>,<span class="number">0x75</span>,<span class="number">0x0C</span>,</span><br><span class="line">		<span class="number">0xFF</span>,<span class="number">0x75</span>,<span class="number">0x08</span>,</span><br><span class="line">		<span class="number">0x53</span>,</span><br><span class="line">		<span class="number">0xB8</span>,<span class="number">0x34</span>,<span class="number">0x12</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,</span><br><span class="line">		<span class="number">0xBB</span>,<span class="number">0x34</span>,<span class="number">0x12</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,</span><br><span class="line">		<span class="number">0xC1</span>,<span class="number">0xE0</span>,<span class="number">0x10</span>,</span><br><span class="line">		<span class="number">0x09</span>,<span class="number">0xD8</span>,</span><br><span class="line">		<span class="number">0x5B</span>,</span><br><span class="line">		<span class="number">0xFF</span>,<span class="number">0xD0</span>,</span><br><span class="line">		<span class="number">0x83</span>,<span class="number">0xC4</span>,<span class="number">0x40</span>,</span><br><span class="line">		<span class="number">0x8B</span>,<span class="number">0xE5</span>,</span><br><span class="line">		<span class="number">0x5D</span>,</span><br><span class="line">		<span class="number">0xC2</span>,<span class="number">0x08</span>,<span class="number">0x00</span></span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	ULONG_PTR addr = FindDllSpace(pDriver-&gt;DriverStart, <span class="keyword">sizeof</span>(bufcode));</span><br><span class="line">	KdPrintEx((<span class="number">77</span>, <span class="number">0</span>, <span class="string">&quot;%x\r\n&quot;</span>, addr));</span><br><span class="line">	ULONG_PTR tempAddr = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (addr)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//修复</span></span><br><span class="line">		ULONG_PTR low = (ULONG_PTR)Dispatch &amp; <span class="number">0xFFFF</span>;</span><br><span class="line">		ULONG_PTR hei = ((ULONG_PTR)Dispatch &gt;&gt; <span class="number">0x10</span>) &amp; <span class="number">0xFFFF</span>;</span><br><span class="line">		*(PULONG)&amp;bufcode[<span class="number">14</span>] = hei;</span><br><span class="line">		*(PULONG)&amp;bufcode[<span class="number">19</span>] = low;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//映射</span></span><br><span class="line">		PHYSICAL_ADDRESS phy = MmGetPhysicalAddress(addr);</span><br><span class="line">		PVOID mem = MmMapIoSpace(phy, <span class="keyword">sizeof</span>(bufcode), MmCached);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (mem)</span><br><span class="line">		&#123;</span><br><span class="line"></span><br><span class="line">			<span class="built_in">memcpy</span>(mem, bufcode, <span class="keyword">sizeof</span>(bufcode));</span><br><span class="line">			MmUnmapIoSpace(mem, <span class="keyword">sizeof</span>(bufcode));</span><br><span class="line">			tempAddr = addr;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!tempAddr)</span><br><span class="line">	&#123;</span><br><span class="line">		tempAddr = Dispatch;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	pDriver-&gt;MajorFunction[IRP_MJ_DEVICE_CONTROL] = tempAddr; </span><br><span class="line"></span><br><span class="line">	PKLDR_DATA_TABLE_ENTRY ldr = (PKLDR_DATA_TABLE_ENTRY)pDriver-&gt;DriverSection;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(pDriver-&gt;DriverExtension-&gt;ServiceKeyName.Buffer, <span class="number">0</span>, pDriver-&gt;DriverExtension-&gt;ServiceKeyName.Length);</span><br><span class="line">	pDriver-&gt;DriverExtension-&gt;ServiceKeyName.Length = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ldr)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">memset</span>(ldr-&gt;FullDllName.Buffer, <span class="number">0</span>, ldr-&gt;FullDllName.Length);</span><br><span class="line">		<span class="built_in">memset</span>(ldr-&gt;BaseDllName.Buffer, <span class="number">0</span>, ldr-&gt;BaseDllName.Length);</span><br><span class="line">		ldr-&gt;BaseDllName.Length = <span class="number">0</span>;</span><br><span class="line">		ldr-&gt;FullDllName.Length = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//把文件锁定</span></span><br><span class="line">	hFile = LockFile(<span class="string">L&quot;\\??\\C:\\windows\\system32\\drivers\\NULL.SYS&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">//创建符号</span></span><br><span class="line">	<span class="comment">//1.找到设备</span></span><br><span class="line">	PDEVICE_OBJECT pDevice = pDriver-&gt;DeviceObject;</span><br><span class="line">	<span class="comment">//如果设备不存在则创建设备</span></span><br><span class="line">	<span class="keyword">if</span> (!pDriver)</span><br><span class="line">	&#123;</span><br><span class="line">		status = IoCreateDevice(pDriver, <span class="number">0</span>, &amp;DeviceName, FILE_DEVICE_UNKNOWN, FILE_DEVICE_SECURE_OPEN, FALSE, &amp;pDevice);</span><br><span class="line">		<span class="keyword">if</span> (!NT_SUCCESS(status))</span><br><span class="line">		&#123;</span><br><span class="line">			KdPrint((<span class="string">&quot;device failed status = %x\r\n&quot;</span>, status));</span><br><span class="line">			pDriver-&gt;MajorFunction[IRP_MJ_DEVICE_CONTROL] = olDisPath;</span><br><span class="line">			<span class="keyword">return</span> FALSE;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="comment">//给设备创建一个R3可识别的名字</span></span><br><span class="line">	status = IoCreateSymbolicLink(unRandName, &amp;DeviceName);</span><br><span class="line">	<span class="keyword">if</span> (!NT_SUCCESS(status))</span><br><span class="line">	&#123;</span><br><span class="line">		KdPrint((<span class="string">&quot;IoCreateSymbolicLink failed status = %x\r\n&quot;</span>, status));</span><br><span class="line">		<span class="comment">//如果失败 删除设备</span></span><br><span class="line">		IoDeleteDevice(pDevice);</span><br><span class="line">		pDriver-&gt;MajorFunction[IRP_MJ_DEVICE_CONTROL] = olDisPath;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	PEPROCESS eporocess = GetProcessByName(<span class="string">L&quot;explorer.exe&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//遍历模块</span></span><br><span class="line">	ULONG_PTR moduleAddr = GetDllModule(eporocess, <span class="string">L&quot;ntdll.dll&quot;</span>);</span><br><span class="line">	KdPrintEx((<span class="number">77</span>,<span class="number">0</span>,<span class="string">&quot;moduleAddr = %x\r\n&quot;</span>, moduleAddr));</span><br><span class="line"></span><br><span class="line">	<span class="comment">//转换 \\\\.\\xxxxxxx \\??\\xxxxxxxx</span></span><br><span class="line">	<span class="keyword">wchar_t</span> bufferName[<span class="number">60</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	RtlStringCbPrintfW(bufferName, <span class="number">60</span> * <span class="number">2</span>, <span class="string">L&quot;\\\\.\\%ws&quot;</span>, unRandName-&gt;Buffer+<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">	KAPC_STATE kApcState = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	KeStackAttachProcess(eporocess, &amp;kApcState);</span><br><span class="line"></span><br><span class="line">	PVOID mem = MmMapIoSpace(MmGetPhysicalAddress(moduleAddr), <span class="number">200</span>, MmCached);</span><br><span class="line">	<span class="keyword">if</span> (mem)</span><br><span class="line">	&#123;</span><br><span class="line">		PUCHAR pTemp = (PUCHAR)mem + <span class="keyword">sizeof</span>(IMAGE_DOS_HEADER);</span><br><span class="line">		<span class="built_in">memcpy</span>(pTemp, bufferName, wcslen(bufferName) * <span class="number">2</span> + <span class="number">2</span>);</span><br><span class="line">		MmUnmapIoSpace(mem, <span class="number">200</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	KeUnstackDetachProcess(&amp;kApcState);</span><br><span class="line"></span><br><span class="line">	ObDereferenceObject(eporocess);</span><br><span class="line"></span><br><span class="line">	gCallBack = callback;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">UnRegisterComm</span><span class="params">(PDRIVER_OBJECT pDriver)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	KdPrint((<span class="string">&quot;DriverUnload\r\n&quot;</span>));</span><br><span class="line"></span><br><span class="line">	PDRIVER_OBJECT pDriver1 = FindDriverObject(<span class="string">L&quot;\\Driver\\NULL&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (pDriver == <span class="literal">NULL</span>) <span class="keyword">return</span> FALSE;</span><br><span class="line">	pDriver1-&gt;MajorFunction[IRP_MJ_DEVICE_CONTROL] = olDisPath;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (hFile)NtClose(hFile);</span><br><span class="line"></span><br><span class="line">	PUNICODE_STRING unRandName = GetSymRandName();</span><br><span class="line">	IoDeleteSymbolicLink(unRandName);</span><br><span class="line">	<span class="comment">//先释放里面的 再释放外面的</span></span><br><span class="line">	ExFreePool(unRandName-&gt;Buffer);</span><br><span class="line">	ExFreePool(unRandName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>main函数无变动</li>
</ul>
<h2 id="R3代码-3"><a href="#R3代码-3" class="headerlink" title="R3代码"></a>R3代码</h2><ul>
<li>DriverComm.h</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">COMM_TYPE</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	CMD_TEST = <span class="number">0</span></span><br><span class="line">&#125;COMM_TYPE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">COMMDATA</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	ULONG cmd;</span><br><span class="line">	ULONG reuslt;</span><br><span class="line">	ULONG64 data;</span><br><span class="line">	ULONG64 size;</span><br><span class="line">&#125;COMMDATA, * PCOMMDATA;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOLEAN <span class="title">DriverCommInit</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">BOOLEAN <span class="title">DriverComm</span><span class="params">(COMM_TYPE cmd, PVOID data, ULONG size)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>DriverComm.cpp</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;DriverComm.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SYM_NAME <span class="meta-string">L&quot;\\\\.\\NUL&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CODE_INDEX 0x800</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CT_TEST CTL_CODE(FILE_DEVICE_UNKNOWN,CODE_INDEX,METHOD_BUFFERED,FILE_ANY_ACCESS)</span></span><br><span class="line"></span><br><span class="line">HANDLE hDevice = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOLEAN <span class="title">DriverCommInit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HANDLE  hModule = GetModuleHandle(<span class="string">L&quot;ntdll.dll&quot;</span>);</span><br><span class="line">	PWCH symName = (PWCH)((PUCHAR)hModule + <span class="keyword">sizeof</span>(IMAGE_DOS_HEADER));</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;====%S====\r\n&quot;</span>, symName);</span><br><span class="line"></span><br><span class="line">	hDevice = CreateFile(symName, GENERIC_READ | GENERIC_WRITE, <span class="number">0</span>, <span class="literal">NULL</span>, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (hDevice == INVALID_HANDLE_VALUE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%s %d\r\n&quot;</span>, __FUNCTION__, GetLastError());</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> x = DriverCommInit();</span><br><span class="line"></span><br><span class="line"><span class="function">BOOLEAN <span class="title">DriverComm</span><span class="params">(COMM_TYPE cmd, PVOID data, ULONG size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	COMMDATA cmddata;</span><br><span class="line">	cmddata.cmd = cmd;</span><br><span class="line">	cmddata.size = size;</span><br><span class="line">	cmddata.data = (ULONG64)data;</span><br><span class="line">	ULONG pro = <span class="number">0</span>;</span><br><span class="line">	DeviceIoControl(hDevice, CT_TEST, &amp;cmddata, <span class="keyword">sizeof</span>(cmddata), <span class="literal">NULL</span>,<span class="literal">NULL</span>, &amp;pro, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">return</span> cmddata.reuslt == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>main.cpp</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;winioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;DriverComm.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">A</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	ULONG x;</span><br><span class="line">&#125;A;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	A a = &#123; <span class="number">100</span> &#125;;</span><br><span class="line">	DriverComm(CMD_TEST, &amp;a, <span class="keyword">sizeof</span>(A));</span><br><span class="line">	system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="驱动通信总结"><a href="#驱动通信总结" class="headerlink" title="驱动通信总结"></a>驱动通信总结</h2><p><img src="https://gitee.com/ZDDR/blog_img/raw/master/img/x86_kernel_drive/%E9%A9%B1%E5%8A%A8%E9%80%9A%E4%BF%A1%E6%80%BB%E7%BB%93.png" alt="image-20201120151845335"></p>
<h1 id="修复异常"><a href="#修复异常" class="headerlink" title="修复异常"></a>修复异常</h1><h2 id="为什么要修复异常"><a href="#为什么要修复异常" class="headerlink" title="为什么要修复异常"></a>为什么要修复异常</h2><p>假设现在有如下代码</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> *x=<span class="number">0</span>;</span><br><span class="line">    *x = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">exption</span><br><span class="line">&#123;</span><br><span class="line">    xxx;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码中把0地址的值改为1触发异常</p>
<p>触发异常后会判断<code>exption</code>函数的地址在不在模块内</p>
<p>如果在模块内才是正确的地址，由于我们使用的是内存加载<code>exption</code>肯定不在模块内，所以我们要修复异常</p>
<h2 id="分析相关函数"><a href="#分析相关函数" class="headerlink" title="分析相关函数"></a>分析相关函数</h2><p>32位上，有一个专门管理异常的函数<code>RtlLookupFunctionTable</code></p>
<p>在IDA查看该函数的引用可以跟到一个<code>RtlIsValidHandler</code>函数，这个函数的作用是验证一个函数的地址有没有效</p>
<p><code>RtlIsValidHandler</code>函数F5</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> __usercall RtlIsValidHandler@&lt;al&gt;(<span class="keyword">int</span> funcAddr@&lt;eax&gt;)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> funcAddr1; <span class="comment">// edi</span></span><br><span class="line">  <span class="keyword">int</span> tableException; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> tableSize1; <span class="comment">// esi</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> offset; <span class="comment">// edi</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// edx</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// ecx</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v8; <span class="comment">// ebx</span></span><br><span class="line">  <span class="keyword">int</span> imageBase; <span class="comment">// [esp+10h] [ebp-8h]</span></span><br><span class="line">  <span class="keyword">int</span> tableSize; <span class="comment">// [esp+14h] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  funcAddr1 = funcAddr;</span><br><span class="line">  tableException = RtlLookupFunctionTable(funcAddr, &amp;imageBase, &amp;tableSize);</span><br><span class="line">  <span class="keyword">if</span> ( !tableException )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  tableSize1 = tableSize;</span><br><span class="line">  <span class="keyword">if</span> ( !tableSize )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( tableException != <span class="number">-1</span> || tableSize != <span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    offset = funcAddr1 - imageBase;</span><br><span class="line">    v6 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( tableSize &gt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">        v7 = (v6 + tableSize1) &gt;&gt; <span class="number">1</span>;</span><br><span class="line">        v8 = *(_DWORD *)(tableException + <span class="number">4</span> * v7);</span><br><span class="line">        <span class="keyword">if</span> ( offset &gt;= v8 )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( offset &lt;= v8 )</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">          v6 = v7 + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( !v7 )</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">          tableSize1 = v7 - <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> ( tableSize1 &gt;= v6 );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到<code>RtlIsValidHandler</code>的参数为一个函数地址</p>
<p>然后把函数地址传给<code>RtlLookupFunctionTable</code>,<code>RtlLookupFunctionTable</code>通过返回传入函数的<strong>imageBase</strong>（模块地址），以及<strong>tableSize</strong>（异常表大小），并通过返回值返回<strong>异常表</strong>。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tableException = RtlLookupFunctionTable(funcAddr, &amp;imageBase, &amp;tableSize);</span><br></pre></td></tr></table></figure>
<p>接下来跟进<code>RtlLookupFunctionTable</code>查看实现</p>
<p>首先判断链表释放为空，是则dllbase=0</p>
<p><img src="https://gitee.com/ZDDR/blog_img/raw/master/img/x86_kernel_drive/%E6%98%AF%E5%88%99dllbase0.png" alt="image-20201124152327010"></p>
<p>如果不为空，遍历在哪个模块内，找到模块后，break</p>
<p>然后把异常的表和异常表的size拿到，返回</p>
<p><img src="https://gitee.com/ZDDR/blog_img/raw/master/img/x86_kernel_drive/%E8%BF%94%E5%9B%9Eimagebese.png" alt="image-20201124153401204"></p>
<h1 id="References"><a href="#References" class="headerlink" title="References:"></a>References:</h1><blockquote>
<p>《牛逼的火哥》</p>
</blockquote>
<blockquote>
<p>《Windows内核原理与实现》</p>
</blockquote>
<blockquote>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://docs.microsoft.com/zh-cn/windows-hardware/drivers/debugger/bug-check-code-reference2">《Bug Check Code Reference》</a></p>
</blockquote>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined" rel="external nofollow noreferrer">ZDDR</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://zddr.net/2020/11/11/x86%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/">https://zddr.net/2020/11/11/x86内核-驱动/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://zddr.net" target="_blank">ZDDR's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/C-C/">C/C++</a><a class="post-meta__tags" href="/tags/%E6%B1%87%E7%BC%96/">汇编</a></div><div class="post_share"><div class="social-share" data-image="https://s2.ax1x.com/2020/02/11/1oFBM8.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/11/25/x86%E5%86%85%E6%A0%B8-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/"><img class="prev-cover" src="https://s2.ax1x.com/2020/02/11/1oFBM8.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">x86内核-系统调用</div></div></a></div><div class="next-post pull-right"><a href="/2020/11/10/x86%E5%86%85%E6%A0%B8-%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F--%E6%8E%A7%E5%88%B6%E5%AF%84%E5%AD%98%E5%99%A8/"><img class="next-cover" src="https://s2.ax1x.com/2020/02/11/1oFBM8.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">x86内核-保护模式--控制寄存器</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2020/02/08/Hook/" title="Hook"><img class="cover" src="https://s2.ax1x.com/2020/02/01/1GlsKJ.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-02-08</div><div class="title">Hook</div></div></a></div><div><a href="/2020/11/10/x86内核-保护模式--控制寄存器/" title="x86内核-保护模式--控制寄存器"><img class="cover" src="https://s2.ax1x.com/2020/02/11/1oFBM8.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-11-10</div><div class="title">x86内核-保护模式--控制寄存器</div></div></a></div><div><a href="/2020/12/15/x86内核-句柄/" title="x86内核-句柄"><img class="cover" src="https://s2.ax1x.com/2020/02/11/1oFBM8.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-12-15</div><div class="title">x86内核-句柄</div></div></a></div><div><a href="/2020/10/29/x86内核-保护模式--页/" title="x86内核-保护模式--页"><img class="cover" src="https://s2.ax1x.com/2020/02/11/1oFBM8.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-10-29</div><div class="title">x86内核-保护模式--页</div></div></a></div><div><a href="/2020/11/25/x86内核-系统调用/" title="x86内核-系统调用"><img class="cover" src="https://s2.ax1x.com/2020/02/11/1oFBM8.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-11-25</div><div class="title">x86内核-系统调用</div></div></a></div><div><a href="/2020/12/01/x86内核-进程线程(烂尾中。。)/" title="x86内核-进程线程(烂尾中。。)"><img class="cover" src="https://s2.ax1x.com/2020/02/11/1oFBM8.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-12-01</div><div class="title">x86内核-进程线程(烂尾中。。)</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%86%85%E6%A0%B8%E7%9A%84%E4%B8%80%E4%BA%9B%E6%A6%82%E5%BF%B5"><span class="toc-number">1.</span> <span class="toc-text">内核的一些概念</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Windows%E5%86%85%E6%A0%B8%E8%AF%A6%E7%BB%86%E7%BB%84%E6%88%90%E7%BB%93%E6%9E%84"><span class="toc-number">1.1.</span> <span class="toc-text">Windows内核详细组成结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E4%BB%8E%E4%B8%89%E7%8E%AF%E8%BF%9B%E5%85%A5%E5%86%85%E6%A0%B8%E4%BE%8B%E7%A8%8B"><span class="toc-number">1.2.</span> <span class="toc-text">函数从三环进入内核例程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HTL%E7%9B%B8%E5%85%B3%E6%96%87%E4%BB%B6"><span class="toc-number">1.3.</span> <span class="toc-text">HTL相关文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%84%E7%BB%84%E4%BB%B6%E6%8E%A5%E5%8F%A3%E5%87%BD%E6%95%B0%E7%9A%84%E5%89%8D%E7%BC%80"><span class="toc-number">1.4.</span> <span class="toc-text">各组件接口函数的前缀</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%AC%AC%E4%B8%80%E4%B8%AA%E9%A9%B1%E5%8A%A8"><span class="toc-number">2.</span> <span class="toc-text">创建第一个驱动</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAWDM%E9%A9%B1%E5%8A%A8%E6%A8%A1%E6%9D%BF"><span class="toc-number">2.1.</span> <span class="toc-text">创建WDM驱动模板</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E8%BF%99%E7%95%99%E4%B8%80%E4%B8%AADriverMain%E7%9A%84%E6%A0%87%E5%87%86%E6%A8%A1%E6%9D%BF"><span class="toc-number">2.1.1.</span> <span class="toc-text">在这留一个DriverMain的标准模板</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A9%B1%E5%8A%A8%E5%85%A5%E5%8F%A3%E5%87%BD%E6%95%B0DriverEntry"><span class="toc-number">2.2.</span> <span class="toc-text">驱动入口函数DriverEntry</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%94%E5%9B%9E%E5%80%BCNTSTATUS"><span class="toc-number">2.2.1.</span> <span class="toc-text">返回值NTSTATUS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E6%95%B01-PDRIVER-OBJECT-pDriver"><span class="toc-number">2.2.2.</span> <span class="toc-text">参数1 PDRIVER_OBJECT pDriver</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E6%95%B02-PUNICODE-STRING-pReg"><span class="toc-number">2.2.3.</span> <span class="toc-text">参数2 PUNICODE_STRING pReg</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A9%B1%E5%8A%A8%E5%8D%B8%E8%BD%BD"><span class="toc-number">2.3.</span> <span class="toc-text">驱动卸载</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A9%B1%E5%8A%A8%E6%B3%A8%E5%86%8C%E4%BA%86%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">2.4.</span> <span class="toc-text">驱动注册了什么？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A9%B1%E5%8A%A8%E4%B8%8EWinDbg%E8%81%94%E5%8A%A8%E8%B0%83%E8%AF%95"><span class="toc-number">2.5.</span> <span class="toc-text">驱动与WinDbg联动调试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%93%9D%E5%B1%8F%E8%B0%83%E8%AF%95"><span class="toc-number">3.</span> <span class="toc-text">蓝屏调试</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%94%99%E8%AF%AF1%EF%BC%9A%E7%BA%BF%E7%A8%8B%E6%9C%AA%E7%BB%93%E6%9D%9F"><span class="toc-number">3.1.</span> <span class="toc-text">错误1：线程未结束</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF"><span class="toc-number">3.1.1.</span> <span class="toc-text">基本信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A0%86%E6%A0%88%E4%BF%A1%E6%81%AF"><span class="toc-number">3.1.2.</span> <span class="toc-text">堆栈信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87IDA%E5%AE%9A%E4%BD%8D%E9%94%99%E8%AF%AF%E5%87%BD%E6%95%B0"><span class="toc-number">3.1.3.</span> <span class="toc-text">通过IDA定位错误函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ln%E6%8C%87%E4%BB%A4"><span class="toc-number">3.1.4.</span> <span class="toc-text">ln指令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%94%99%E8%AF%AF2%EF%BC%9A%E5%A0%86%E6%A0%88%E6%BA%A2%E5%87%BA"><span class="toc-number">3.2.</span> <span class="toc-text">错误2：堆栈溢出</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%94%99%E8%AF%AF3%EF%BC%9A0%E5%9C%B0%E5%9D%80%E9%94%99%E8%AF%AF"><span class="toc-number">3.3.</span> <span class="toc-text">错误3：0地址错误</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A9%B1%E5%8A%A8%E6%96%AD%E9%93%BE"><span class="toc-number">4.</span> <span class="toc-text">驱动断链</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#PDRIVER-OBJECT%E7%BB%93%E6%9E%84"><span class="toc-number">4.1.</span> <span class="toc-text">PDRIVER_OBJECT结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DriverSection%E7%BB%93%E6%9E%84"><span class="toc-number">4.1.1.</span> <span class="toc-text">DriverSection结构</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E4%BB%A3%E7%A0%81"><span class="toc-number">4.2.</span> <span class="toc-text">编写代码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%81%8D%E5%8E%86%E9%A9%B1%E5%8A%A8"><span class="toc-number">4.2.1.</span> <span class="toc-text">遍历驱动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E8%87%AA%E5%B7%B1%E6%96%AD%E9%93%BE"><span class="toc-number">4.2.2.</span> <span class="toc-text">将自己断链</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E5%88%AB%E4%BA%BA%E6%96%AD%E9%93%BE"><span class="toc-number">4.2.3.</span> <span class="toc-text">将别人断链</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E4%B8%AA%E7%8C%A5%E7%90%90%E7%9A%84%E4%B8%9C%E8%A5%BF"><span class="toc-number">4.2.4.</span> <span class="toc-text">一个猥琐的东西</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A9%B1%E5%8A%A8%E9%80%9A%E4%BF%A1"><span class="toc-number">5.</span> <span class="toc-text">驱动通信</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E9%A9%B1%E5%8A%A8%E9%80%9A%E4%BF%A1"><span class="toc-number">5.1.</span> <span class="toc-text">如何进行驱动通信?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8IoCreateDevice%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AAio%E8%AE%BE%E5%A4%87"><span class="toc-number">5.2.</span> <span class="toc-text">使用IoCreateDevice创建一个io设备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%AC%A6%E5%8F%B7%E9%93%BE%E6%8E%A5%E8%AE%A9%E4%B8%89%E7%8E%AF%E8%AE%BF%E9%97%AE"><span class="toc-number">5.3.</span> <span class="toc-text">创建符号链接让三环访问</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E6%B4%BE%E9%81%A3%E5%87%BD%E6%95%B0"><span class="toc-number">5.4.</span> <span class="toc-text">注册派遣函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFIRP%EF%BC%9F"><span class="toc-number">5.5.</span> <span class="toc-text">什么是IRP？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#IRP%E7%9A%84%E7%BB%93%E6%9E%84"><span class="toc-number">5.5.1.</span> <span class="toc-text">IRP的结构</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MajorFunction%E6%B4%BE%E9%81%A3%E5%87%BD%E6%95%B0"><span class="toc-number">5.6.</span> <span class="toc-text">MajorFunction派遣函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A9%B1%E5%8A%A8%E4%BB%A3%E7%A0%81"><span class="toc-number">5.7.</span> <span class="toc-text">驱动代码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#R3%E4%BB%A3%E7%A0%81"><span class="toc-number">5.7.1.</span> <span class="toc-text">R3代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8A%AB%E6%8C%81%E8%AE%BE%E5%A4%87%E9%80%9A%E4%BF%A1"><span class="toc-number">6.</span> <span class="toc-text">劫持设备通信</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#R3%E4%BB%A3%E7%A0%81-1"><span class="toc-number">6.1.</span> <span class="toc-text">R3代码</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9A%90%E8%97%8F%E9%A9%B1%E5%8A%A8%E9%80%9A%E4%BF%A1"><span class="toc-number">7.</span> <span class="toc-text">隐藏驱动通信</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#R3%E4%BB%A3%E7%A0%81-2"><span class="toc-number">7.1.</span> <span class="toc-text">R3代码</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A9%B1%E5%8A%A8%E9%9A%8F%E6%9C%BA%E5%8C%96"><span class="toc-number">8.</span> <span class="toc-text">驱动随机化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#R3%E4%BB%A3%E7%A0%81-3"><span class="toc-number">8.1.</span> <span class="toc-text">R3代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A9%B1%E5%8A%A8%E9%80%9A%E4%BF%A1%E6%80%BB%E7%BB%93"><span class="toc-number">8.2.</span> <span class="toc-text">驱动通信总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D%E5%BC%82%E5%B8%B8"><span class="toc-number">9.</span> <span class="toc-text">修复异常</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E4%BF%AE%E5%A4%8D%E5%BC%82%E5%B8%B8"><span class="toc-number">9.1.</span> <span class="toc-text">为什么要修复异常</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E7%9B%B8%E5%85%B3%E5%87%BD%E6%95%B0"><span class="toc-number">9.2.</span> <span class="toc-text">分析相关函数</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#References"><span class="toc-number">10.</span> <span class="toc-text">References:</span></a></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url(https://s2.ax1x.com/2020/02/11/1oFBM8.png)"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2021 By ZDDR</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> {preloader.endLoading()})</script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></body></html>